<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YR1B2Z51N0"></script>
  <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     gtag('config', 'G-YR1B2Z51N0');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/mylogo_nevengi_circle.webp" type="image/jpg">
  <title>Nevengi User Dashboard</title>
  <style>
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f9f9f9; color: #333; }
    header { background: #008cba; color: white; padding: 1rem; text-align: center; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .hidden { display: none; }
    button { background: #008cba; color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    nav { display: flex; gap: 1rem; margin-bottom: 1rem; }
    nav button { flex: 1; }
    section { display: none; }
    section.active { display: block; }
    h2 { margin-bottom: 1rem; }
    ul { list-style: none; }
    li { background: white; margin-bottom: 0.5rem; padding: 0.75rem; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* Hide mobile nav on desktop by default */
    .mobile-bottom-nav { display: none; }

    /* Explore Coaches */
    .coach-item { display: flex; justify-content: space-between; align-items: center; }
    .coach-info { flex: 1; }
    .coach-action button { margin-left: 0.5rem; }
    /* Highlight the invited coach */
    .coach-item.pinned {
      border: 2px solid #008cba;
      background: #e6f7ff;
    }

    /* Rewards Shop */
    #shopify-collection { display: flex; gap: 1rem; flex-wrap: wrap; }
    /* Leaderboard */
    #leaderboard li { display: flex; justify-content: space-between; }
    /* XP/Maples */
    .status-box { background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    /* Pricing Plans */
    .pricing-options { display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 1rem; }
    .pricing-option { background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .recommended-label { background: gold; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; }

    @media (max-width: 768px) {
      .dashboard-nav { display: none !important; }
      .mobile-bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100vw;
        background: #fff;
        border-top: 1px solid #eee;
        box-shadow: 0 -2px 12px rgba(0,0,0,0.07);
        z-index: 1000;
        justify-content: space-around;
        padding: 0.25rem 0;
        height: 64px;
      }
      .mobile-bottom-nav button {
        flex: 1;
        background: none;
        border: none;
        color: #008cba;
        font-size: 1.1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.25rem 0 0.1rem 0;
        border-radius: 0;
        box-shadow: none;
        transition: background 0.2s;
      }
      .mobile-bottom-nav button:active, .mobile-bottom-nav button.active {
        background: #e6f7ff;
        color: #005f7a;
      }
      .mobile-bottom-nav span {
        font-size: 1.5rem;
        line-height: 1;
      }
      .mobile-bottom-nav div {
        font-size: 0.75rem;
        margin-top: 2px;
      }
      body { padding-bottom: 70px; }
      #headerRightBtns { display: none !important; }
      #hamburgerMenuBtn { display: block !important; }
      #mobileMenu { display: flex; }
    }
    @media (min-width: 769px) {
      #mobileMenu, #hamburgerMenuBtn { display: none !important; }
    }

    /* Home Tab */
    .character-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 1rem;
    }
    .character-img {
      width: 62.4vw !important;
      max-width: 624px !important;
      min-width: 250px !important;
      height: auto !important;
      border-radius: 50% !important;
      margin-bottom: 1rem !important;
      display: block !important;
    }
    .character-info {
      text-align: center;
    }
    .unlockables, .daily-stats, .affirmation {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .unlockables ul {
      list-style: none;
      padding: 0;
    }
    .unlockables li {
      margin-bottom: 0.5rem;
    }
    .progress-bar-wrapper {
      width: 100%;
      margin-top: 0.3em;
      margin-bottom: 0.5em;
    }
    .progress-bar-bg {
      width: 100%;
      height: 18px;
      background: #e0e0e0;
      border-radius: 9px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .progress-bar-xp {
      height: 100%;
      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
      border-radius: 9px 0 0 9px;
      transition: width 0.5s cubic-bezier(.4,2,.6,1);
      width: 0;
    }
    .progress-bar-maple {
      height: 100%;
      background: linear-gradient(90deg, #ffb347 0%, #ff7f50 100%);
      border-radius: 9px 0 0 9px;
      transition: width 0.5s cubic-bezier(.4,2,.6,1);
      width: 0;
    }
  </style>
</head>
<body>
  <script>
  function isPWA() {
    return window.matchMedia('(display-mode: standalone)').matches ||
           window.navigator.standalone ||
           document.referrer.includes('android-app://');
  }
  const expectedPWA = localStorage.getItem('expectedPWA');
  if (expectedPWA !== null) {
    const inPWA = isPWA();
    if ((expectedPWA === 'true' && !inPWA) || (expectedPWA === 'false' && inPWA)) {
      document.body.innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);color:#fff;display:flex;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#222;padding:2rem;border-radius:1rem;text-align:center;max-width:90vw;">
            <h2>Wrong Context</h2>
            <p>Please open the Nevengi app (PWA) to continue if you started there, or use the browser if you started there.</p>
          </div>
        </div>
      `;
    }
  }
  </script>
  <header style="display:flex;align-items:center;justify-content:space-between;background:#008cba;color:white;padding:1rem 2rem;position:relative;">
    <!-- Hamburger menu for mobile -->
    <button id="hamburgerMenuBtn" aria-label="Open menu" style="display:none;background:none;border:none;font-size:2rem;color:white;cursor:pointer;margin-right:1rem;z-index:1101;">
      &#9776;
    </button>
    <div style="display:flex;align-items:center;gap:1rem;">
      <img id="userProfilePic" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" alt="Profile Picture" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #fff;background:#eee;">
      <span id="userName" style="font-size:1.3rem;font-weight:bold;"></span>
    </div>
    <div id="headerRightBtns" style="display:flex;align-items:center;gap:1rem;">
      <button id="reportsTopBtn" style="background:#005f7a;">Reports</button>
      <button id="logoutBtn">Logout</button>
    </div>
    <!-- Mobile hamburger dropdown -->
    <div id="mobileMenu" style="display:none;position:absolute;top:100%;left:0;width:180px;background:#fff;color:#333;box-shadow:0 4px 16px rgba(0,0,0,0.13);border-radius:0 0 8px 8px;z-index:1100;flex-direction:column;overflow:hidden;">
      <button id="mobilePlansBtn" style="background:none;color:#29acd8;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Plans</button>
      <button id="mobileSettingsBtn" style="background:none;color:#008cba;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Settings</button>
      <button id="mobileLeadersBtn" style="background:none;color:#008cba;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Leaders</button>
      <button id="mobileLogoutBtn" style="background:none;color:#d32f2f;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Logout</button>
    </div>
  </header>

  <!-- Login Screen -->
  <div id="loginScreen" class="container">
    <h2>Login with Discord</h2>
    <button id="loginBtn">Login with Discord</button>
    <div style="margin-top:1.5rem;">
      <p style="margin-bottom:0.5rem;color:#008cba;font-weight:500;">For the best experience, use our mobile app!</p>
      <button id="installAppBtn" style="background:#005f7a;">Install Nevengi App</button>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="container hidden">
    <div style="flex:1;">
      <nav class="dashboard-nav">
        <button data-tab="explore">Explore Coaches</button>
        <button data-tab="rewards">Rewards Shop</button>
        <button data-tab="leaderboard">Leaderboard</button>
        <button data-tab="status">My XP & Maples</button>
        <button data-tab="plans">Pricing Plans</button>
        <button data-tab="reports">Reports</button>
        <button data-tab="home">Home</button>
        <button data-tab="settings">Settings</button>
        <a href="model.html" class="btn">Go to Page 2</a>
      </nav>

      <!-- Explore Coaches -->
      <section id="explore">
        <h2>Explore Coaches</h2>
        <ul id="coachList"></ul>
      </section>

      <!-- Rewards Shop (Shopify) -->
      <section id="rewards">
        <h2>Rewards Shop</h2>
        <div id="newUserReward" style="background:#e6ffe6;border:2px solid #43e97b;padding:1em 1.5em;border-radius:10px;margin-bottom:1.5em;display:none;align-items:center;justify-content:space-between;gap:1em;">
          <div style="flex:1;">
            <strong style="font-size:1.1em;color:#2e7d32;">üéâ New User Free XP</strong>
            <div style="margin-top:0.3em;">Claim <b>200 XP</b> as a welcome gift!</div>
          </div>
          <button id="claimNewUserXpBtn" style="background:#43e97b;color:#fff;font-weight:bold;padding:0.5em 1.5em;border-radius:6px;font-size:1em;">Claim</button>
        </div>
        <div id="shopify-collection"></div>
      </section>

      <!-- Leaderboard -->
      <section id="leaderboard">
        <h2>Leaderboard</h2>
        <ul id="leaderboardList"></ul>
      </section>

      <!-- XP & Maples -->
      <section id="status">
        <h2>My Status</h2>
        <div class="status-box">
          <div style="margin-bottom:1em;">
            <strong>XP:</strong> <span id="xpAmount">0</span>
            <div class="progress-bar-wrapper">
              <div class="progress-bar-bg">
                <div class="progress-bar-xp" id="xpBar"></div>
              </div>
            </div>
          </div>
          <div>
            <strong>Maples:</strong> <span id="mapleAmount">0</span>
            <div class="progress-bar-wrapper">
              <div class="progress-bar-bg">
                <div class="progress-bar-maple" id="mapleBar"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Pricing Plans (PayPal Subscriptions) -->
      <section id="plans">
        <h2>Pricing Plans</h2>
        <div class="pricing-options">
          <div class="pricing-option">
            <h3>I'm Broke(General Membership)</h3>
            <p>
              <span class="price-usd" data-usd="13.99">$13.99</span>
              <span class="local-price"></span>
              / month
            </p>
            <ul>
              <li>Basic resources</li>
              <li>Community Access</li>
              <li>Check-ins every 2 weeks</li>
            </ul>
            <div id="paypal-button-container-1"></div>
          </div>
          <div class="pricing-option">
            <h3>I'm Serious(Gold Membership)</h3>
            <p>
              <span class="price-usd" data-usd="40.00">$40.00</span>
              <span class="local-price"></span>
              / month
            </p>
            <span class="recommended-label">Recommended</span>
            <ul>
              <li>Most resources</li>
              <li>Premium Community</li>
              <li>Weekly Check-ins</li>
            </ul>
            <div id="paypal-button-container-2"></div>
          </div>
          <div class="pricing-option">
            <h3>I want to be Exclusive(Nevengi Club Membership)</h3>
            <p>
              <span class="price-usd" data-usd="129.00">$129.00</span>
              <span class="local-price"></span>
              / month
            </p>
            <span class="recommended-label">VIP</span>
            <ul>
              <li>Nevengi Club Card</li>
              <li>All resources</li>
              <li>VIP Community</li>
              <li>2√ó Weekly Check-ins</li>
              <li>Priority Support</li>
            </ul>
            <div id="paypal-button-container-3"></div>
          </div>
          <div class="pricing-option">
            <h3>Buy Maples (One-Time)</h3>
            <p>
              <span class="price-usd" data-usd="5.00">$5.00</span>
              <span class="local-price"></span>
              <span style="font-size:0.95em;color:#888;">/ one-time</span>
            </p>
            <ul>
              <li>Get 100 Maples instantly</li>
              <li>One-time purchase, not a subscription</li>
            </ul>
            <div id="paypal-button-container-maples"></div>
          </div>
        </div>
      </section>

      <!-- Home Tab -->
      <section id="home" class="active">
        <div class="character-display">
          <img src="images/man.png" alt="Character" class="character-img">
          <div class="character-info">
            <h2>Level <span id="userLevel">1</span></h2>
            <p><strong>XP:</strong> <span id="homeXp">0</span></p>
            <p><strong>Maples:</strong> <span id="homeMaples">0</span></p>
          </div>
        </div>
        <div class="unlockables">
          <h3>Future Unlocks</h3>
          <ul>
            <li>Exclusive Nevengi Club Card</li>
            <li>Special Character Skins</li>
            <li>Daily Challenges</li>
          </ul>
        </div>
        <div class="daily-stats">
          <h3>Today's Stats</h3>
          <p>Steps: 5000</p>
          <p>Calories Burned: 300</p>
        </div>
        <div class="affirmation">
          <h3>Daily Affirmation</h3>
          <p>"Every day is a new opportunity to grow and improve."</p>
        </div>
      </section>

      <!-- Reports -->
      <section id="reports">
        <h2>Weekly Reports</h2>
        <div id="reportsContainer">Loading reports‚Ä¶</div>
      </section>
      <!-- Settings -->
      <section id="settings">
        <h2>Settings</h2>
        <div style="margin-bottom:1.5rem;">
          <label style="font-weight:bold;display:block;margin-bottom:0.5em;">Profile Gender</label>
          <span id="genderLabel" style="font-size:1.1em;font-weight:500;">-</span>
        </div>
      </section>
    </div>
  </div>

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?
       client-id=AfHtfA-t7x13qyJhGsb4JBu2z8XulDrnr407Eb8d36peTeos6Q80YrRUm1owoRrPldprDxh5HFaLsxrZ
       &vault=true
       &intent=subscription
       &enable-funding=card,applepay,googlepay">
  </script>

  <!-- Load and run your PayPal module -->
  <script type="module">
    import { renderPayPalButtons } from '/js/paypal-buttons.js';
    renderPayPalButtons();
  </script>

  <!-- Dashboard Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const API_BASE = '';

      // Login flow
      document.getElementById('loginBtn').addEventListener('click', () => {
        window.location.href = '/auth/discord/user';
      });

      // Handle OAuth callback
      const params = new URLSearchParams(window.location.search);
      if (params.has('token')) {
        localStorage.setItem('userToken', params.get('token'));
        localStorage.setItem('discordId', params.get('discord_id'));
        history.replaceState({}, '', window.location.pathname);
      }

      const token = localStorage.getItem('userToken');

      // Show dashboard if logged in
      if (token) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
      }

      // Tab navigation handler for both navs
      function handleTabClick(tab) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        // Set active state on both navs
        document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => {
          if (btn.dataset.tab === tab) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      // Attach handler to both navs
      document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => {
        btn.addEventListener('click', () => handleTabClick(btn.dataset.tab));
      });

      // Set initial active tab
      handleTabClick('home');

      // Helper: render one coach, with optional pinned styling and subscription status
      function renderCoachItem(coach, isSubscribed = false, pinned = false) {
        // Social links icons
        const socials = coach.social_links || {};
        const socialIcons = [
          socials.instagram ? `<a href='${socials.instagram}' target='_blank' title='Instagram'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/instagram.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.twitter ? `<a href='${socials.twitter}' target='_blank' title='Twitter'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/twitter.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.linkedin ? `<a href='${socials.linkedin}' target='_blank' title='LinkedIn'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/linkedin.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.youtube ? `<a href='${socials.youtube}' target='_blank' title='YouTube'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/youtube.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.tiktok ? `<a href='${socials.tiktok}' target='_blank' title='TikTok'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/tiktok.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.threads ? `<a href='${socials.threads}' target='_blank' title='Threads'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/threads.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.facebook ? `<a href='${socials.facebook}' target='_blank' title='Facebook'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/facebook.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : ''
        ].join('');
        const profilePic = coach.profile_picture ? coach.profile_picture : 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png';
        const avgRating = coach.average_rating ? Number(coach.average_rating).toFixed(2) : 'N/A';
        // Star rating UI for subscribed users
        let ratingUI = '';
        if (isSubscribed) {
          ratingUI = `<span class='star-rating' data-coach='${coach._id}'>
            ${[1,2,3,4,5].map(i => `<span class='star' data-value='${i}' style='font-size:1.3em;cursor:pointer;color:#ccc;'>&#9733;</span>`).join('')}
            <span class='rate-label' style='font-size:0.95em;color:#888;margin-left:0.5em;'></span>
          </span>`;
        }
        return `
          <li class="coach-item${pinned ? ' pinned' : ''}">
            <div class="coach-info" style="display:flex;align-items:center;gap:1em;">
              <img src="${profilePic}" alt="Profile" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #eee;background:#fff;">
              <div style="flex:1;">
                ${pinned ? '<strong style=\"color:#008cba;\">[Invited Coach]</strong> ' : ''}
                <strong>${coach.name}</strong> ‚Äì ${(coach.specialties || []).join(', ')}<br>
                <span style='font-size:0.95em;color:#888;'>${coach.experience || ''}</span><br>
                <span style='font-size:0.95em;'>${socialIcons}</span><br>
                <span style='font-size:0.95em;color:#f39c12;'>‚≠ê ${avgRating}</span>
                ${ratingUI}
              </div>
            </div>
            <div class="coach-action">
              <button ${isSubscribed ? 'disabled' : ''} onclick="${isSubscribed ? '' : `subscribe('${coach._id}')`}">${isSubscribed ? 'Subscribed' : 'Subscribe'}</button>
              ${isSubscribed ? `<button onclick=\"unsubscribe('${coach._id}')\" style=\"background:#d32f2f;\">Unsubscribe</button>` : ''}
            </div>
          </li>
        `;
      }

      // Load Explore Coaches with My Coaches at the top
      async function loadCoaches() {
        const headers = { Authorization: 'Bearer ' + token };

        // Fetch user's subscribed coaches
        const myCoachesRes = await fetch(`${API_BASE}/api/my_coaches`, { headers });
        const myCoaches = myCoachesRes.ok ? await myCoachesRes.json() : [];
        const myCoachIds = new Set(myCoaches.map(c => c.coach_id));

        // Fetch all coaches
        const allRes = await fetch(`${API_BASE}/api/coaches`, { headers });
        const allCoaches = allRes.ok ? await allRes.json() : [];

        // Split coaches into subscribed and others
        const subscribedCoaches = allCoaches.filter(c => myCoachIds.has(c._id));
        const otherCoaches = allCoaches.filter(c => !myCoachIds.has(c._id));

        // Build HTML
        let html = '';
        if (subscribedCoaches.length) {
          html += '<h3 style="margin-top:1em;">My Coaches</h3>';
          html += '<ul>';
          subscribedCoaches.forEach(c => {
            html += renderCoachItem(c, true);
          });
          html += '</ul>';
        }
        html += '<h3 style="margin-top:1.5em;">Explore Coaches</h3>';
        html += '<ul>';
        otherCoaches.forEach(c => {
          html += renderCoachItem(c, false);
        });
        html += '</ul>';

        document.getElementById('coachList').innerHTML = html;
      }

      // Other loaders (leaderboard, status, shop, etc.)
      async function loadLeaderboard() {
        const res = await fetch(`${API_BASE}/api/leaderboard`, { headers: { Authorization: 'Bearer ' + token } });
        const data = await res.json();
        document.getElementById('leaderboardList').innerHTML = data.map(u => `<li>${u.username} <span>${u.xp}</span></li>`).join('');
      }

      async function loadStatus() {
        // Get level, xp, maples from user-profile (not just status)
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch(`${API_BASE}/api/user-profile`, { headers });
        if (!res.ok) return;
        const user = await res.json();
        const xp = Number(user.xp) || 0;
        const maples = Number(user.maples) || 0;
        const level = Number(user.level) || 1;
        document.getElementById('xpAmount').textContent = xp;
        document.getElementById('mapleAmount').textContent = maples;
        // Home tab
        document.getElementById('userLevel').textContent = level;
        document.getElementById('homeXp').textContent = xp;
        document.getElementById('homeMaples').textContent = maples;
        // Progress bars (set max as you wish)
        const xpMax = 5000;
        const mapleMax = 1000;
        document.getElementById('xpBar').style.width = Math.min(100, (xp / xpMax) * 100) + '%';
        document.getElementById('mapleBar').style.width = Math.min(100, (maples / mapleMax) * 100) + '%';
      }

      async function loadShop() {
        document.getElementById('shopify-collection').textContent = 'Shop items will appear here';
        // New User Free XP logic
        const headers = { Authorization: 'Bearer ' + token };
        // Check if user has claimed (assume user-profile returns claimed_new_user_xp)
        const res = await fetch('/api/user-profile', { headers });
        if (!res.ok) return;
        const user = await res.json();
        const rewardDiv = document.getElementById('newUserReward');
        if (user.claimed_new_user_xp) {
          rewardDiv.style.display = 'none';
        } else {
          rewardDiv.style.display = 'flex';
        }
      }

      // Add a modal for insufficient maples
      if (!document.getElementById('insufficientMapleModal')) {
        const modal = document.createElement('div');
        modal.id = 'insufficientMapleModal';
        modal.style = 'display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:12px;max-width:90vw;min-width:300px;text-align:center;box-shadow:0 4px 24px rgba(0,0,0,0.18);">
            <div id="insufficientMapleMsg" style="font-size:1.1em;margin-bottom:1.5em;"></div>
            <div style="display:flex;gap:1em;justify-content:center;">
              <button id="findCheaperBtn" style="background:#aaa;">Find a cheaper coach</button>
              <button id="addMaplesBtn" style="background:#008cba;">Add More maples</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('findCheaperBtn').onclick = () => { modal.style.display = 'none'; };
        document.getElementById('addMaplesBtn').onclick = () => {
          modal.style.display = 'none';
          handleTabClick('plans');
        };
      }

      window.subscribe = async function(coachId) {
        // Get coach info and user maples
        const headers = { Authorization: 'Bearer ' + token };
        const [coachRes, userRes] = await Promise.all([
          fetch(`${API_BASE}/api/coaches`, { headers }),
          fetch(`${API_BASE}/api/user-profile`, { headers })
        ]);
        const allCoaches = coachRes.ok ? await coachRes.json() : [];
        const coach = allCoaches.find(c => c._id === coachId);
        const user = userRes.ok ? await userRes.json() : {};
        const userMaples = Number(user.maples) || 0;
        const coachPrice = Number(coach?.monthly_price_maples) || 0;
        if (userMaples < coachPrice) {
          // Show modal
          const modal = document.getElementById('insufficientMapleModal');
          document.getElementById('insufficientMapleMsg').innerHTML = `This coach costs <b>${coachPrice} maples</b>, but you only have <b>${userMaples}</b>.<br>Either buy extra maples from the plans section or find a cheaper coach.`;
          modal.style.display = 'flex';
          return;
        }
        if (!confirm('Are you sure you want to subscribe to this coach?')) return;
        try {
          const res = await fetch(`${API_BASE}/api/subscribe`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ coachId })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            alert('Successfully subscribed!');
            loadCoaches(); // Optionally refresh the list
            loadStatus(); // Refresh maples
          } else {
            alert(data.error || 'Failed to subscribe.');
          }
        } catch (err) {
          alert('An error occurred. Please try again.');
        }
      }
      window.rate = function(coachId) {
        const rating = prompt('Rate out of 5');
        if (!rating) return;
        alert('Rated ' + coachId + ' as ' + rating);
      }

      // Pricing plan currency conversion
      const RATES = { USD:1, EUR:0.93, GBP:0.80, CAD:1.36 };
      const locale = navigator.language || 'en-US';
      const userCcy = new Intl.NumberFormat(locale,{style:'currency',currency:'USD'}).resolvedOptions().currency;
      document.querySelectorAll('.pricing-option').forEach(opt => {
        const usdEl = opt.querySelector('.price-usd');
        const localEl = opt.querySelector('.local-price');
        const usd = parseFloat(usdEl.dataset.usd);
        if (!usd || userCcy==='USD') return;
        const conv = usd * (RATES[userCcy]||1);
        localEl.textContent = ` (${new Intl.NumberFormat(locale,{style:'currency',currency:userCcy}).format(conv)})`;
      });

      // Load user profile picture and name
      async function loadUserProfilePic() {
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch(`${API_BASE}/api/user-profile`, { headers });
        if (!res.ok) return;
        const user = await res.json();
        let avatarUrl = 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png';
        if (user.avatar && user.discord_id) {
          avatarUrl = `https://cdn.discordapp.com/avatars/${user.discord_id}/${user.avatar}.png`;
        }
        document.getElementById('userProfilePic').src = avatarUrl;
        document.getElementById('userName').textContent = user.username || '';
      }
      if (token) loadUserProfilePic();

      // Initialize all data
      if (token) {
        loadCoaches();
        loadLeaderboard();
        loadStatus();
        loadShop();
      }

      document.getElementById('logoutBtn').addEventListener('click', function() {
        if (!confirm('Are you sure you want to log out?')) return;
        localStorage.removeItem('userToken');
        localStorage.removeItem('discordId');
        localStorage.removeItem('expectedPWA');
        window.location.href = '/';
      });

      let deferredPrompt;
      const installBtn = document.getElementById('installAppBtn');
      if (installBtn) {
        installBtn.style.display = 'none';
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          installBtn.style.display = 'inline-block';
        });
        installBtn.addEventListener('click', async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            installBtn.style.display = 'none';
          }
        });
      }

      // Add handler for top-right Reports button
      document.getElementById('reportsTopBtn').addEventListener('click', function() {
        handleTabClick('reports');
      });

      // Fetch and render weekly reports
      async function loadReports() {
        const container = document.getElementById('reportsContainer');
        container.textContent = 'Loading reports‚Ä¶';
        try {
          const res = await fetch(`/api/reports`, { headers: { Authorization: 'Bearer ' + token } });
          if (!res.ok) throw new Error('Failed to fetch reports');
          const reports = await res.json();
          if (!reports.length) {
            container.textContent = 'No reports yet.';
            return;
          }
          // Render reports as scrollable cards
          container.innerHTML = `<div style="display:flex;overflow-x:auto;gap:1rem;padding-bottom:1rem;">${reports.map(report => `
            <div style="min-width:320px;max-width:340px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:1rem;flex-shrink:0;display:flex;flex-direction:column;">
              <div style="font-weight:bold;font-size:1.1rem;margin-bottom:0.5rem;">Week ${report.weekNumber}, ${report.year}</div>
              <div style="margin-bottom:0.5rem;">
                <strong>Weekly Data:</strong>
                <pre style="background:#f6f8fa;padding:0.5rem;border-radius:4px;overflow-x:auto;font-size:0.95em;">${JSON.stringify(report.data, null, 2)}</pre>
              </div>
              <div style="margin-top:auto;">
                <strong>Coach Reviews:</strong>
                ${report.reviews && report.reviews.length ? report.reviews.map(r => `
                  <div style=\"margin:0.5em 0;padding:0.5em;background:#e6f7ff;border-radius:4px;\"><b>${r.coach_name}:</b> ${r.review}</div>
                `).join('') : '<div style="color:#888;">No reviews yet.</div>'}
              </div>
            </div>
          `).join('')}</div>`;
        } catch (err) {
          container.textContent = 'Failed to load reports.';
        }
      }

      // Load reports when Reports tab is activated
      document.querySelectorAll('[data-tab="reports"]').forEach(btn => {
        btn.addEventListener('click', loadReports);
      });

      // Hamburger menu logic for mobile
      const hamburgerMenuBtn = document.getElementById('hamburgerMenuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobilePlansBtn = document.getElementById('mobilePlansBtn');
      const mobileSettingsBtn = document.getElementById('mobileSettingsBtn');
      const mobileLeadersBtn = document.getElementById('mobileLeadersBtn');
      const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
      // Show/hide menu
      if (hamburgerMenuBtn && mobileMenu) {
        hamburgerMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          if (mobileMenu.style.display === 'flex') {
            mobileMenu.style.display = 'none';
          } else {
            mobileMenu.style.display = 'flex';
          }
        });
        // Hide menu when clicking outside
        document.addEventListener('click', function(e) {
          if (!mobileMenu.contains(e.target) && e.target !== hamburgerMenuBtn) {
            mobileMenu.style.display = 'none';
          }
        });
        // Hide menu on resize to desktop
        window.addEventListener('resize', function() {
          if (window.innerWidth > 768) {
            mobileMenu.style.display = 'none';
          }
        });
      }
      // Plans button logic
      if (mobilePlansBtn) {
        mobilePlansBtn.addEventListener('click', function() {
          mobileMenu.style.display = 'none';
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
          document.getElementById('plans').classList.add('active');
          // Set active state on navs
          document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => {
            if (btn.dataset.tab === 'plans') {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
        });
      }
      // Leaders button logic
      if (mobileLeadersBtn) {
        mobileLeadersBtn.addEventListener('click', function() {
          mobileMenu.style.display = 'none';
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
          document.getElementById('leaderboard').classList.add('active');
          // Set active state on navs
          document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => btn.classList.remove('active'));
        });
      }
      // Logout button logic
      if (mobileLogoutBtn) {
        mobileLogoutBtn.addEventListener('click', function() {
          if (!confirm('Are you sure you want to log out?')) return;
          localStorage.removeItem('userToken');
          localStorage.removeItem('discordId');
          localStorage.removeItem('expectedPWA');
          window.location.href = '/';
        });
      }
      // Settings button logic
      if (mobileSettingsBtn) {
        mobileSettingsBtn.addEventListener('click', function() {
          mobileMenu.style.display = 'none';
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
          document.getElementById('settings').classList.add('active');
          // Set active state on navs
          document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => btn.classList.remove('active'));
        });
      }
      // Settings section logic
      const genderLabel = document.getElementById('genderLabel');
      function updateCharacterImage(gender) {
        const img = document.querySelector('.character-img');
        if (img) {
          img.src = gender === 'female' ? 'images/lady.png' : 'images/man.png';
        }
      }
      async function loadUserGenderAndSetImage() {
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch('/api/user-profile', { headers });
        if (!res.ok) return;
        const user = await res.json();
        let gender = 'male';
        if (user.gender && user.gender.toLowerCase() === 'female') {
          gender = 'female';
        }
        genderLabel.textContent = gender.charAt(0).toUpperCase() + gender.slice(1);
        updateCharacterImage(gender);
      }
      if (token) loadUserGenderAndSetImage();

      // Claim New User XP logic
      const claimBtn = document.getElementById('claimNewUserXpBtn');
      if (claimBtn) {
        claimBtn.addEventListener('click', async function() {
          claimBtn.disabled = true;
          claimBtn.textContent = 'Claiming...';
          const headers = { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' };
          const res = await fetch('/api/claim-new-user-xp', { method: 'POST', headers });
          const data = await res.json();
          if (data.success && data.claimed) {
            document.getElementById('newUserReward').style.display = 'none';
            // Optionally reload status to update XP
            loadStatus();
          } else {
            claimBtn.disabled = false;
            claimBtn.textContent = 'Claim';
            alert('Could not claim reward.');
          }
        });
      }

      window.unsubscribe = async function(coachId) {
        if (!confirm('Are you sure you want to unsubscribe? Your money won\'t be refunded if you already have paid.')) return;
        try {
          const res = await fetch(`${API_BASE}/api/unsubscribe`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ coachId })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            alert('You have unsubscribed from this coach.');
            loadCoaches();
            loadStatus();
          } else {
            alert(data.error || 'Failed to unsubscribe.');
          }
        } catch (err) {
          alert('An error occurred. Please try again.');
        }
      }

      // Star rating event delegation
      document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('star')) {
          const span = e.target.closest('.star-rating');
          const coachId = span.getAttribute('data-coach');
          const value = Number(e.target.getAttribute('data-value'));
          // Highlight stars
          span.querySelectorAll('.star').forEach(star => {
            star.style.color = Number(star.getAttribute('data-value')) <= value ? '#f39c12' : '#ccc';
          });
          span.querySelector('.rate-label').textContent = `You rated ${value} star${value > 1 ? 's' : ''}`;
          // Send to backend
          const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
          try {
            const res = await fetch(`${API_BASE}/api/rate`, {
              method: 'POST',
              headers,
              body: JSON.stringify({ coachId, rating: value })
            });
            const data = await res.json();
            if (res.ok && data.success) {
              alert('Thank you for rating!');
              loadCoaches();
            } else {
              alert(data.error || 'Failed to rate coach.');
            }
          } catch (err) {
            alert('An error occurred. Please try again.');
          }
        }
      });
    });
  </script>

  <!-- Add mobile bottom nav -->
  <nav class="mobile-bottom-nav">
    <button data-tab="explore"><span>üèÜ</span><div>Coaches</div></button>
    <button data-tab="rewards"><span>üéÅ</span><div>Rewards</div></button>
    <button data-tab="home"><span>üè†</span><div>Home</div></button>
    <button data-tab="status"><span>üå±</span><div>Status</div></button>
    <button data-tab="reports"><span>üìÑ</span><div>Reports</div></button>
  </nav>
</body>
</html>
