<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YR1B2Z51N0"></script>
  <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     gtag('config', 'G-YR1B2Z51N0');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/nevengilogo.webp" type="image/webp">
  <title>Nevengi User Dashboard</title>
  <link rel="stylesheet" href="user_dashboard.css">
  <!-- OneSignal Web Push SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "7572a4ea-e59a-4b7f-b914-16f34530aa59",
        safari_web_id: "web.onesignal.auto.48cecb45-b9e1-42c4-afaa-e45f7f034833",
        notifyButton: { enable: false }, // Hide the bell
        serviceWorkerPath: 'OneSignalSDKWorker.js',
        // serviceWorkerUpdaterPath: 'OneSignalSDKUpdaterWorker.js', // Uncomment if you add this file
      });
      // Show custom prompt if not granted/denied
      const permission = await OneSignal.Notifications.permissionLevel;
      if (permission === 'default') {
        document.getElementById('custom-notify-prompt').style.display = 'block';
      }
      document.getElementById('enable-notifications-btn').onclick = async function() {
        await OneSignal.Notifications.requestPermission();
        // After permission, tag user with their _id for push targeting
        try {
          const token = localStorage.getItem('userToken');
          if (token) {
            const res = await fetch('/api/user-profile', { headers: { Authorization: 'Bearer ' + token } });
            if (res.ok) {
              const user = await res.json();
              if (user && user._id) {
                OneSignal.User.addTag('user_id', user._id);
              }
            }
          }
        } catch (e) { /* ignore */ }
        document.getElementById('custom-notify-prompt').style.display = 'none';
      };
    });
  </script>
  <!-- Add Google Fonts for geometric sans-serif -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Add Phosphor Icons CDN -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
  <script>
    function showPopup(element, number, name) {
      const popup = element.querySelector('.popup');
      popup.textContent = `${number} - ${name}`;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 2000);
    }
  </script>
  <script>
  // Robust PWA/mobile/desktop detection for context check
  function isReallyPWA() {
    // 1. Display mode checks
    if (
      window.matchMedia('(display-mode: standalone)').matches ||
      window.matchMedia('(display-mode: minimal-ui)').matches ||
      window.matchMedia('(display-mode: fullscreen)').matches ||
      window.matchMedia('(display-mode: window-controls-overlay)').matches
    ) return true;
    // 2. iOS Safari
    if (typeof window.navigator.standalone !== 'undefined' && window.navigator.standalone) return true;
    // 3. Android TWA
    if (document.referrer && document.referrer.startsWith('android-app://')) return true;
    // 4. Service worker control
    if (navigator.serviceWorker && navigator.serviceWorker.controller) return true;
    // 5. LaunchQueue API (experimental)
    if (typeof window.launchQueue !== 'undefined') return true;
    // 6. Chromium userAgentData
    if (navigator.userAgentData && navigator.userAgentData.mobile && window.matchMedia('(display-mode: standalone)').matches) return true;
    return false;
  }
  const expectedPWA = localStorage.getItem('expectedPWA');
  if (expectedPWA !== null) {
    const mode = getPWADisplayMode();
    const inPWA = ['standalone','minimal-ui','fullscreen','window-controls-overlay'].includes(mode);
    if ((expectedPWA === 'true' && !inPWA) || (expectedPWA === 'false' && inPWA)) {
      document.body.innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);color:#fff;display:flex;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#222;padding:2rem;border-radius:1rem;text-align:center;max-width:90vw;">
            <h2>Wrong Context</h2>
            <p>Please open the Nevengi app (PWA) to continue if you started there, or use the browser if you started there.</p>
          </div>
        </div>
      `;
    }
  }
  </script>
  <script>
  // Always show install app button, and provide fallback instructions if prompt is not available
  document.addEventListener('DOMContentLoaded', function() {
    let deferredPrompt;
    const installBtn = document.getElementById('installAppBtn');
    if (installBtn) installBtn.style.display = 'inline-block';
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });
    if (installBtn) {
      installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
        } else {
          alert('App installation is not supported on your device, or the app is already installed.');
        }
      });
    }
    window.addEventListener('appinstalled', () => {
      if (installBtn) installBtn.style.display = 'none';
    });
    // Show Get Started button only in PWA or desktop (not mobile web)
    function shouldShowGetStarted() {
      const isPWA = isReallyPWA();
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      return isPWA || !isMobile;
    }
    const getStartedBtn = document.getElementById('getStartedBtn');
    if (getStartedBtn && shouldShowGetStarted()) {
      getStartedBtn.style.display = 'inline-block';
      getStartedBtn.addEventListener('click', function() {
        document.getElementById('loginBtn').click();
      });
    }
  });
  </script>
  <header style="display:flex;align-items:center;justify-content:space-between;background:#232323;color:white;padding:1rem 2rem;position:relative;">
    <!-- Hamburger menu for mobile -->
    <button id="hamburgerMenuBtn" aria-label="Open menu" style="display:none;background:none;border:none;font-size:2rem;color:white;cursor:pointer;margin-right:1rem;z-index:1101;">
      &#9776;
    </button>
    <div style="display:flex;align-items:center;gap:1rem;">
      <img id="userProfilePic" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" alt="Profile Picture" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #fff;background:#eee;">
      <span id="userName" style="font-size:1.3rem;font-weight:bold;"></span>
      <div style="width:100%;display:flex;justify-content:flex-start;margin-top:0.3em;">
        <a href="powerhouses.html" id="powerHouseBtnHeader" style="background:#232323;color:#fff;border:none;border-radius:8px;padding:0.4em 1em;font-size:1em;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:0.5em;box-shadow:0 2px 8px rgba(35,35,35,0.08);transition:background 0.2s;margin-top:0.2em;">
          <i class="ph ph-house icon-minimal"></i> Power House
        </a>
      </div>
    </div>
    <div id="headerRightBtns" style="display:flex;align-items:center;gap:1rem;">
      <button id="reportsTopBtn" style="background:#232323;">Reports</button>
      <button id="logoutBtn" style="background:#232323;">Logout</button>
    </div>
    <!-- Mobile hamburger dropdown -->
    <div id="mobileMenu" style="display:none;position:absolute;top:100%;left:0;width:180px;background:#fff;color:#333;box-shadow:0 4px 16px rgba(0,0,0,0.13);border-radius:0 0 8px 8px;z-index:1100;flex-direction:column;overflow:hidden;">
      <button id="mobilePlansBtn" style="background:none;color:#29acd8;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Plans</button>
      <button id="mobileSettingsBtn" style="background:none;color:#008cba;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Settings</button>
      <button id="mobileLeadersBtn" style="background:none;color:#008cba;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Leaders</button>
      <button id="mobileStatusBtn" style="background:none;color:#008cba;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Status</button>
      <button id="mobileLogoutBtn" style="background:none;color:#d32f2f;padding:1rem;text-align:left;border:none;width:100%;font-size:1rem;">Logout</button>
    </div>
  </header>

  <!-- Login Screen -->
  <div id="loginScreen" class="container">
    <h2>Login with Discord</h2>
    <button id="loginBtn">Login with Discord</button>
    <div style="margin-top:1.5rem;">
      <p style="margin-bottom:0.5rem;color:#008cba;font-weight:500;">For the best experience, use our mobile app!</p>
      <button id="installAppBtn" style="background:#232323;">Install Nevengi App</button>
      <button id="getStartedBtn" style="background:#232323;color:#fff;margin-top:1rem;display:none;">Get Started</button>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="container hidden">
    <div style="flex:1;">
      <nav class="dashboard-nav">
        <button data-tab="explore"><i class="ph ph-magnifying-glass icon-minimal"></i>Explore Coaches</button>
        <button data-tab="rewards"><i class="ph ph-gift icon-minimal"></i>Rewards Shop</button>
        <button data-tab="leaderboard"><i class="ph ph-trophy icon-minimal"></i>Leaderboard</button>
        <button data-tab="status"><i class="ph ph-barbell icon-minimal"></i>My XP & Maples</button>
        <button data-tab="plans"><i class="ph ph-credit-card icon-minimal"></i>Pricing Plans</button>
        <button data-tab="reports"><i class="ph ph-file-text icon-minimal"></i>Reports</button>
        <button data-tab="decision-helper"><i class="ph ph-lightbulb icon-minimal"></i>Decision Helper</button>
        <button data-tab="home"><i class="ph ph-house icon-minimal"></i>Home</button>
        <button data-tab="settings"><i class="ph ph-gear icon-minimal"></i>Settings</button>
        <a href="model.html" class="btn"><i class="ph ph-arrow-right icon-minimal"></i>Go to Page 2</a>
      </nav>

      <!-- Explore Coaches -->
      <section id="explore">
        <h2>Explore Coaches</h2>
        <ul id="coachList"></ul>
      </section>

      <!-- Rewards Shop (Shopify) -->
      <section id="rewards">
        <h2>Rewards Shop</h2>
        <div id="newUserReward" style="background:#e6ffe6;border:2px solid #43e97b;padding:1em 1.5em;border-radius:10px;margin-bottom:1.5em;display:none;align-items:center;justify-content:space-between;gap:1em;">
          <div style="flex:1;">
            <strong style="font-size:1.1em;color:#2e7d32;">üéâ New User Free XP</strong>
            <div style="margin-top:0.3em;">Claim <b>200 XP</b> as a welcome gift!</div>
          </div>
          <button id="claimNewUserXpBtn" style="background:#43e97b;color:#fff;font-weight:bold;padding:0.5em 1.5em;border-radius:6px;font-size:1em;">Claim</button>
        </div>
        <div id="shopify-collection"></div>
      </section>

      <!-- Leaderboard -->
      <section id="leaderboard">
        <h2>Leaderboard</h2>
        <ul id="leaderboardList"></ul>
      </section>

      <!-- XP & Maples -->
      <section id="status">
        <h2>My Status</h2>
        <div class="status-box">
          <div style="margin-bottom:1em;">
            <strong>XP:</strong> <span id="xpAmount">0</span>
            <div class="progress-bar-wrapper">
              <div class="progress-bar-bg">
                <div class="progress-bar-xp" id="xpBar"></div>
              </div>
            </div>
          </div>
          <div>
            <strong>Maples:</strong> <span id="mapleAmount">0</span>
            <div class="progress-bar-wrapper">
              <div class="progress-bar-bg">
                <div class="progress-bar-maple" id="mapleBar"></div>
              </div>
            </div>
          </div>
          <div style="margin-top:1em;">
            <strong>Energy:</strong> <span id="energyAmount">0</span>
            <div class="progress-bar-wrapper">
              <div class="progress-bar-bg">
                <div class="progress-bar-energy" id="energyBar" style="background:#ffd600;"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Pricing Plans (PayPal Subscriptions) -->
      <section id="plans">
        <h2>Pricing Plans</h2>
        <div class="pricing-options">
          <div class="pricing-option">
            <h3>I'm Broke(General Membership)</h3>
            <p>
              <span class="price-usd" data-usd="13.99">$13.99</span>
              <span class="local-price"></span>
              / month
            </p>
            <ul>
              <li>Basic resources</li>
              <li>Community Access</li>
              <li>Check-ins every 2 weeks</li>
            </ul>
            <div id="paypal-button-container-1"></div>
          </div>
          <div class="pricing-option">
            <h3>I'm Serious(Gold Membership)</h3>
            <p>
              <span class="price-usd" data-usd="40.00">$40.00</span>
              <span class="local-price"></span>
              / month
            </p>
            <span class="recommended-label">Recommended</span>
            <ul>
              <li>Most resources</li>
              <li>Premium Community</li>
              <li>Weekly Check-ins</li>
            </ul>
            <div id="paypal-button-container-2"></div>
          </div>
          <div class="pricing-option">
            <h3>I want to be Exclusive(Nevengi Club Membership)</h3>
            <p>
              <span class="price-usd" data-usd="129.00">$129.00</span>
              <span class="local-price"></span>
              / month
            </p>
            <span class="recommended-label">VIP</span>
            <ul>
              <li>Nevengi Club Card</li>
              <li>All resources</li>
              <li>VIP Community</li>
              <li>2√ó Weekly Check-ins</li>
              <li>Priority Support</li>
            </ul>
            <div id="paypal-button-container-3"></div>
          </div>
          <div class="pricing-option">
            <h3>Buy Maples (One-Time)</h3>
            <p>
              <span class="price-usd" data-usd="5.00">$5.00</span>
              <span class="local-price"></span>
              <span style="font-size:0.95em;color:#888;">/ one-time</span>
            </p>
            <ul>
              <li>Get 100 Maples instantly</li>
              <li>One-time purchase, not a subscription</li>
            </ul>
            <div id="paypal-button-container-maples"></div>
          </div>
        </div>
      </section>

      <!-- Home Tab -->
      <section id="home" class="active" style="overflow-y:auto; min-height:100vh; background:var(--background-color);">
        <div id="mythical-habit-home-root"></div>
        <link rel="stylesheet" href="mythical-habit-home.css">
        <script src="mythical-habit-home.js"></script>
      </section>

      <!-- Resources Tab -->
      <section id="resources">
        <h2>Resources</h2>
        <div id="resourcesContainer">Loading resources‚Ä¶</div>
      </section>

      <!-- Reports -->
      <section id="reports">
        <h2>Weekly Reports</h2>
        <div id="reportsContainer">Loading reports‚Ä¶</div>
      </section>

      <!-- Decision Helper Tab -->
      <section id="decision-helper">
        <decision-helper-ui></decision-helper-ui>
      </section>

      <!-- Settings -->
      <section id="settings">
        <h2>Settings</h2>
        <div style="margin-bottom:1.5rem;">
          <label style="font-weight:bold;display:block;margin-bottom:0.5em;">Profile Gender</label>
          <span id="genderLabel" style="font-size:1.1em;font-weight:500;">-</span>
        </div>
        <div style="margin-bottom:1.5rem;">
          <label style="font-weight:bold;display:block;margin-bottom:0.5em;">Dark Mode</label>
          <label class="switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </section>
    </div>
  </div>

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?
       client-id=AfHtfA-t7x13qyJhGsb4JBu2z8XulDrnr407Eb8d36peTeos6Q80YrRUm1owoRrPldprDxh5HFaLsxrZ
       &vault=true
       &intent=subscription
       &enable-funding=card,applepay,googlepay">
  </script>

  <!-- Load and run your PayPal module -->
  <script type="module">
    import { renderPayPalButtons } from '/js/paypal-buttons.js';
    renderPayPalButtons();
  </script>

  <!-- Dashboard Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const API_BASE = '';

      // Login flow
      document.getElementById('loginBtn').addEventListener('click', () => {
        window.location.href = '/auth/discord/user';
      });

      // Handle OAuth callback
      const params = new URLSearchParams(window.location.search);
      if (params.has('token')) {
        localStorage.setItem('userToken', params.get('token'));
        localStorage.setItem('discordId', params.get('discord_id'));
        history.replaceState({}, '', window.location.pathname);
      }

      const token = localStorage.getItem('userToken');

      // Show dashboard if logged in
      if (token) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
      }

      // After login, check if user needs onboarding
      async function checkOnboarding() {
        if (!token) return;
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch('/api/user-profile', { headers });
        if (!res.ok) return;
        const user = await res.json();
        if (user.identity_completed === false || user.identity_completed === undefined) {
          // Redirect to onboarding
          window.location.href = `/user_questions.html?discord_id=${encodeURIComponent(user.discord_id)}`;
        }
      }
      if (token) checkOnboarding();

      // Replace the incomplete profile banner with a multi-step onboarding form
      async function showOnboardingSlidesIfNeeded() {
        if (!token) return;
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch('/api/user-profile', { headers });
        if (!res.ok) return;
        const user = await res.json();
        if (user.identity_completed === false || user.identity_completed === undefined) {
          // Remove old banner if present
          const oldBanner = document.getElementById('incompleteProfileBanner');
          if (oldBanner) oldBanner.remove();
          // Create onboarding container
          let onboarding = document.getElementById('onboardingSlidesBanner');
          if (!onboarding) {
            onboarding = document.createElement('div');
            onboarding.id = 'onboardingSlidesBanner';
            onboarding.style = 'background:linear-gradient(135deg,#fffbe6,#e0f7fa);color:#222;padding:2em 1em 1.5em 1em;text-align:center;font-size:1.1em;font-weight:500;border-radius:16px;margin:1.5em auto 1em auto;max-width:700px;box-shadow:0 2px 16px #0001;position:relative;z-index:10;';
            onboarding.innerHTML = `
              <form id="onboardingSlidesForm" style="max-width:600px;margin:0 auto;">
                <div id="onboardingStep1" class="onboarding-step active" style="display:block;">
                  <h2 style="font-size:1.5em;margin-bottom:1em;color:#3A86FF;">Rate Your Life Sectors</h2>
                  <div class="form-group"><label>Physical Health</label><input type="range" name="physical" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Mental & Emotional Wellbeing</label><input type="range" name="mental" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Social Confidence</label><input type="range" name="social" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Love & Relationships</label><input type="range" name="love" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Career or Business</label><input type="range" name="career" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Creative Expression</label><input type="range" name="creative" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Travel / Adventure</label><input type="range" name="travel" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Family & Close Connections</label><input type="range" name="family" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Personal Style & Appearance</label><input type="range" name="style" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="form-group"><label>Spirituality & Mindset</label><input type="range" name="spiritual" min="1" max="10" value="5" oninput="this.nextElementSibling.textContent=this.value"><span>5</span></div>
                  <div class="btn-group" style="display:flex;justify-content:flex-end;margin-top:1.5em;">
                    <button type="button" id="onboardingNext1" class="button-primary" style="background:#3A86FF;color:#fff;">Next</button>
                  </div>
                </div>
                <div id="onboardingStep2" class="onboarding-step" style="display:none;">
                  <h2 style="font-size:1.5em;margin-bottom:1em;color:#3A86FF;">Identity Details</h2>
                  <div class="form-group"><label>Date of Birth</label><input type="date" name="date_of_birth" required></div>
                  <div class="form-group"><label>Country</label><input type="text" name="country" required placeholder="Enter your country"></div>
                  <div class="form-group"><label>Gender</label><select name="gender" required><option value="">Select</option><option value="male">Male</option><option value="female">Female</option></select></div>
                  <div class="btn-group" style="display:flex;justify-content:space-between;margin-top:1.5em;">
                    <button type="button" id="onboardingBack2" class="button-secondary" style="background:#eee;color:#3A86FF;">Back</button>
                    <button type="button" id="onboardingNext2" class="button-primary" style="background:#3A86FF;color:#fff;">Next</button>
                  </div>
                </div>
                <div id="onboardingStep3" class="onboarding-step" style="display:none;">
                  <h2 style="font-size:1.5em;margin-bottom:1em;color:#3A86FF;">Select the Channels You Like</h2>
                  <div class="channels-group"><h3>Physical Health üèãÔ∏è‚Äç‚ôÇÔ∏è</h3><label><input type="checkbox" name="channel_physical_men"> Physical Fitness for Men</label><label><input type="checkbox" name="channel_physical_women"> Physical Fitness for Women</label><label><input type="checkbox" name="channel_physical_health"> Physical Health</label></div>
                  <div class="channels-group"><h3>Mental & Emotional Wellbeing üßò‚Äç‚ôÇÔ∏è</h3><label><input type="checkbox" name="channel_yoga"> Yoga</label><label><input type="checkbox" name="channel_meditation"> Meditation</label></div>
                  <div class="channels-group"><h3>Social Confidence üó£Ô∏è</h3><label><input type="checkbox" name="channel_public_speaking"> Public Speaking</label><label><input type="checkbox" name="channel_social_confidence"> Social Confidence</label><label><input type="checkbox" name="channel_influencing"> Influencing</label></div>
                  <div class="channels-group"><h3>Love & Relationships ‚ù§Ô∏è</h3><label><input type="checkbox" name="channel_dating_men"> Dating for Men</label><label><input type="checkbox" name="channel_dating_women"> Dating for Women</label></div>
                  <div class="channels-group"><h3>Career or Business üíº</h3><label><input type="checkbox" name="channel_entrepreneurship"> Entrepreneurship</label><label><input type="checkbox" name="channel_work_career"> Work and Career</label><label><input type="checkbox" name="channel_ai"> Artificial Intelligence</label></div>
                  <div class="channels-group"><h3>Creative Expression üé®</h3><label><input type="checkbox" name="channel_art"> Art</label><label><input type="checkbox" name="channel_music"> Music</label><label><input type="checkbox" name="channel_diy"> DIY & Crafting</label></div>
                  <div class="channels-group"><h3>Travel / Adventure ‚úàÔ∏è</h3><label><input type="checkbox" name="channel_travelling"> Travelling</label><label><input type="checkbox" name="channel_adrenaline"> Adrenaline Adventure</label></div>
                  <div class="channels-group"><h3>Family & Close Connections üë®‚Äçüë©‚Äçüëß‚Äçüë¶</h3><label><input type="checkbox" name="channel_family"> Family and Close Friends</label></div>
                  <div class="channels-group"><h3>Personal Style & Appearance üëó</h3><label><input type="checkbox" name="channel_fashion"> Appearance and Fashion</label><label><input type="checkbox" name="channel_minimalism"> Minimalism</label></div>
                  <div class="channels-group"><h3>Spirituality & Mindset üôè</h3><label><input type="checkbox" name="channel_loa"> Law of Attraction</label><label><input type="checkbox" name="channel_manifestation"> Manifestation and Visualization</label><label><input type="checkbox" name="channel_spirituality"> Spirituality</label><label><input type="checkbox" name="channel_stoicism"> Stoicism and Philosophy</label><label><input type="checkbox" name="channel_gratitude"> Gratitude</label><label><input type="checkbox" name="channel_masculine_energy"> Masculine Energy</label><label><input type="checkbox" name="channel_feminine_energy"> Feminine Energy</label><label><input type="checkbox" name="channel_tarot"> Tarot</label></div>
                  <div class="form-group" style="margin-top:1.5em;">
                    <label style="display:flex;align-items:center;gap:10px;">
                      <input type="checkbox" name="myCheckbox" id="myCheckbox" required>
                      <span>I have read and understood the <a href="/terms.html" target="_blank" style="color:#3A86FF;text-decoration:underline;">Terms & Conditions</a> of Nevengi and agree to proceed.</span>
                    </label>
                    <p style="color:#888;font-size:12px;margin-top:5px;">*required</p>
                  </div>
                  <div class="btn-group" style="display:flex;justify-content:space-between;margin-top:1.5em;">
                    <button type="button" id="onboardingBack3" class="button-secondary" style="background:#eee;color:#3A86FF;">Back</button>
                    <button type="submit" id="onboardingSubmitBtn" class="button-primary" style="background:#3A86FF;color:#fff;">Submit</button>
                  </div>
                </div>
              </form>
              <style>
                .onboarding-step { display:none; }
                .onboarding-step.active { display:block; }
                .form-group { margin-bottom:1.2em; }
                .channels-group { margin-bottom:1.2em; text-align:left; }
                .channels-group h3 { margin-bottom:0.5em; color:#3A86FF; font-size:1.1em; }
                .channels-group label { display:inline-block; margin-right:1.2em; margin-bottom:0.5em; font-size:1em; cursor:pointer; }
                .btn-group button { min-width:110px; font-size:1em; border-radius:8px; border:none; padding:0.7em 1.5em; margin:0 0.2em; }
              </style>
            `;
            const dashboard = document.getElementById('dashboard');
            dashboard.parentNode.insertBefore(onboarding, dashboard);
            // Slide navigation logic
            const stepEls = [
              document.getElementById('onboardingStep1'),
              document.getElementById('onboardingStep2'),
              document.getElementById('onboardingStep3')
            ];
            let currentStep = 0;
            function showStep(idx) {
              stepEls.forEach((el,i)=>el.style.display=i===idx?'block':'none');
              currentStep = idx;
            }
            showStep(0);
            document.getElementById('onboardingNext1').onclick = ()=>showStep(1);
            document.getElementById('onboardingBack2').onclick = ()=>showStep(0);
            document.getElementById('onboardingNext2').onclick = ()=>showStep(2);
            document.getElementById('onboardingBack3').onclick = ()=>showStep(1);
            // Form submit logic
            document.getElementById('onboardingSlidesForm').onsubmit = async function(e) {
              e.preventDefault();
              const form = e.target;
              const formData = new FormData(form);
              const data = {};
              for (const [key, value] of formData.entries()) {
                if (data[key] !== undefined) {
                  if (!Array.isArray(data[key])) data[key] = [data[key]];
                  data[key].push(value);
                } else {
                  data[key] = value;
                }
              }
              // Send to backend
              const res = await fetch('/api/complete-profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(data)
              });
              if (res.ok) {
                onboarding.remove();
                // Optionally reload dashboard data
                location.reload();
              } else {
                alert('Failed to complete profile. Please try again.');
              }
            };
          }
        }
      }
      if (token) showOnboardingSlidesIfNeeded();

      // Tab navigation handler for both navs
      function handleTabClick(tab) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        // Set active state on both navs
        document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => {
          if (btn.dataset.tab === tab) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        // Load resources when Resources tab is activated
        if (tab === 'resources') {
          loadResources();
        }
      }

      // Attach handler to both navs
      document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => {
        btn.addEventListener('click', () => handleTabClick(btn.dataset.tab));
      });

      // Set initial active tab
      handleTabClick('home');

      // Helper: render one coach, with optional pinned styling and subscription status
      function renderCoachItem(coach, isSubscribed = false, pinned = false) {
        // Social links icons
        const socials = coach.social_links || {};
        const socialIcons = [
          socials.instagram ? `<a href='${socials.instagram}' target='_blank' title='Instagram'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/instagram.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.twitter ? `<a href='${socials.twitter}' target='_blank' title='Twitter'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/twitter.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.linkedin ? `<a href='${socials.linkedin}' target='_blank' title='LinkedIn'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/linkedin.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.youtube ? `<a href='${socials.youtube}' target='_blank' title='YouTube'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/youtube.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.tiktok ? `<a href='${socials.tiktok}' target='_blank' title='TikTok'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/tiktok.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.threads ? `<a href='${socials.threads}' target='_blank' title='Threads'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/threads.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : '',
          socials.facebook ? `<a href='${socials.facebook}' target='_blank' title='Facebook'><img src='https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/facebook.svg' style='width:20px;height:20px;margin-right:4px;vertical-align:middle;'></a>` : ''
        ].join('');
        const profilePic = coach.profile_picture ? coach.profile_picture : 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png';
        const avgRating = coach.average_rating ? Number(coach.average_rating).toFixed(2) : 'N/A';
        // Star rating UI for subscribed users
        let ratingUI = '';
        if (isSubscribed) {
          ratingUI = `<span class='star-rating' data-coach='${coach._id}'>
            ${[1,2,3,4,5].map(i => `<span class='star' data-value='${i}' style='font-size:1.3em;cursor:pointer;color:#ccc;'>&#9733;</span>`).join('')}
            <span class='rate-label' style='font-size:0.95em;color:#888;margin-left:0.5em;'></span>
          </span>`;
        }
        return `
          <li class="coach-item${pinned ? ' pinned' : ''}">
            <div class="coach-info" style="display:flex;align-items:center;gap:1em;">
              <img src="${profilePic}" alt="Profile" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #eee;background:#fff;">
              <div style="flex:1;">
                ${pinned ? '<strong style=\"color:#008cba;\">[Invited Coach]</strong> ' : ''}
                <strong>${coach.name}</strong> ‚Äì ${(coach.specialties || []).join(', ')}<br>
                <span style='font-size:0.95em;color:#888;'>${coach.experience || ''}</span><br>
                <span style='font-size:0.95em;'>${socialIcons}</span><br>
                <span style='font-size:0.95em;color:#f39c12;'>‚≠ê ${avgRating}</span>
                ${ratingUI}
              </div>
            </div>
            <div class="coach-action">
              <button ${isSubscribed ? 'disabled' : ''} onclick="${isSubscribed ? '' : `subscribe('${coach._id}')`}">${isSubscribed ? 'Subscribed' : 'Subscribe'}</button>
              ${isSubscribed ? `<button onclick=\"unsubscribe('${coach._id}')\" style=\"background:#d32f2f;\">Unsubscribe</button>` : ''}
            </div>
          </li>
        `;
      }

      // Load Explore Coaches with My Coaches at the top
      async function loadCoaches() {
        const headers = { Authorization: 'Bearer ' + token };

        // Fetch user's subscribed coaches
        const myCoachesRes = await fetch(`${API_BASE}/api/my_coaches`, { headers });
        const myCoaches = myCoachesRes.ok ? await myCoachesRes.json() : [];
        const myCoachIds = new Set(myCoaches.map(c => c.coach_id));

        // Fetch all coaches
        const allRes = await fetch(`${API_BASE}/api/coaches`, { headers });
        const allCoaches = allRes.ok ? await allRes.json() : [];

        // Split coaches into subscribed and others
        const subscribedCoaches = allCoaches.filter(c => myCoachIds.has(c._id));
        const otherCoaches = allCoaches.filter(c => !myCoachIds.has(c._id));

        // Build HTML
        let html = '';
        if (subscribedCoaches.length) {
          html += '<h3 style="margin-top:1em;">My Coaches</h3>';
          html += '<ul>';
          subscribedCoaches.forEach(c => {
            html += renderCoachItem(c, true);
          });
          html += '</ul>';
        }
        html += '<h3 style="margin-top:1.5em;">Explore Coaches</h3>';
        html += '<ul>';
        otherCoaches.forEach(c => {
          html += renderCoachItem(c, false);
        });
        html += '</ul>';

        document.getElementById('coachList').innerHTML = html;
      }

      // Other loaders (leaderboard, status, shop, etc.)
      async function loadLeaderboard() {
        const res = await fetch(`${API_BASE}/api/leaderboard`, { headers: { Authorization: 'Bearer ' + token } });
        const data = await res.json();
        document.getElementById('leaderboardList').innerHTML = data.map(u => `<li>${u.username} <span>${u.xp}</span></li>`).join('');
      }

      async function loadStatus() {
        // Get level, xp, maples from user-profile (not just status)
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch(`${API_BASE}/api/user-profile`, { headers });
        if (!res.ok) return;
        const user = await res.json();
        console.log('User profile for dashboard:', user); // Debug log
        const xp = Number(user.xp) || 0;
        const maples = Number(user.maples) || 0;
        const level = Number(user.level) || 1;
        const energy = Number(user.energy) || 0;
        document.getElementById('xpAmount').textContent = xp;
        document.getElementById('mapleAmount').textContent = maples;
        document.getElementById('energyAmount').textContent = energy;
        // Home tab
        document.getElementById('userLevel').textContent = level;
        document.getElementById('homeXp').textContent = xp;
        document.getElementById('homeMaples').textContent = maples;
        // Progress bars (set max as you wish)
        const xpMax = 5000;
        const mapleMax = 1000;
        const energyMax = 1000;
        document.getElementById('xpBar').style.width = Math.max(0, Math.min(100, (xp / xpMax) * 100)) + '%';
        document.getElementById('mapleBar').style.width = Math.max(0, Math.min(100, (maples / mapleMax) * 100)) + '%';
        document.getElementById('energyBar').style.width = Math.max(0, Math.min(100, (energy / energyMax) * 100)) + '%';
        // Extract the 10 category values from user, check both top-level and user.niches
        userCategoryData = {
          physical: user.physical ?? user.niches?.physical,
          mental: user.mental ?? user.niches?.mental,
          social: user.social ?? user.niches?.social,
          love: user.love ?? user.niches?.love,
          career: user.career ?? user.niches?.career,
          creative: user.creative ?? user.niches?.creative,
          travel: user.travel ?? user.niches?.travel,
          family: user.family ?? user.niches?.family,
          style: user.style ?? user.niches?.style,
          spiritual: user.spiritual ?? user.niches?.spiritual
        };
        attachIconPopups();
      }

      async function loadShop() {
        document.getElementById('shopify-collection').textContent = 'Shop items will appear here';
        // New User Free XP logic
        const headers = { Authorization: 'Bearer ' + token };
        // Check if user has claimed (assume user-profile returns claimed_new_user_xp)
        const res = await fetch('/api/user-profile', { headers });
        if (!res.ok) return;
        const user = await res.json();
        const rewardDiv = document.getElementById('newUserReward');
        if (user.claimed_new_user_xp) {
          rewardDiv.style.display = 'none';
        } else {
          rewardDiv.style.display = 'flex';
        }
      }

      // Add a modal for insufficient maples
      if (!document.getElementById('insufficientMapleModal')) {
        const modal = document.createElement('div');
        modal.id = 'insufficientMapleModal';
        modal.style = 'display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:12px;max-width:90vw;min-width:300px;text-align:center;box-shadow:0 4px 24px rgba(0,0,0,0.18);">
            <div id="insufficientMapleMsg" style="font-size:1.1em;margin-bottom:1.5em;"></div>
            <div style="display:flex;gap:1em;justify-content:center;">
              <button id="findCheaperBtn" style="background:#aaa;">Find a cheaper coach</button>
              <button id="addMaplesBtn" style="background:#008cba;">Add More maples</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('findCheaperBtn').onclick = () => { modal.style.display = 'none'; };
        document.getElementById('addMaplesBtn').onclick = () => {
          modal.style.display = 'none';
          handleTabClick('plans');
        };
      }

      window.subscribe = async function(coachId) {
        // Get coach info and user maples
        const headers = { Authorization: 'Bearer ' + token };
        const [coachRes, userRes] = await Promise.all([
          fetch(`${API_BASE}/api/coaches`, { headers }),
          fetch(`${API_BASE}/api/user-profile`, { headers })
        ]);
        const allCoaches = coachRes.ok ? await coachRes.json() : [];
        const coach = allCoaches.find(c => c._id === coachId);
        const user = userRes.ok ? await userRes.json() : {};
        const userMaples = Number(user.maples) || 0;
        const coachPrice = Number(coach?.monthly_price_maples) || 0;
        if (userMaples < coachPrice) {
          // Show modal
          const modal = document.getElementById('insufficientMapleModal');
          document.getElementById('insufficientMapleMsg').innerHTML = `This coach costs <b>${coachPrice} maples</b>, but you only have <b>${userMaples}</b>.<br>Either buy extra maples from the plans section or find a cheaper coach.`;
          modal.style.display = 'flex';
          return;
        }
        if (!confirm('Are you sure you want to subscribe to this coach?')) return;
        try {
          const res = await fetch(`${API_BASE}/api/subscribe`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ coachId })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            alert('Successfully subscribed!');
            loadCoaches(); // Optionally refresh the list
            loadStatus(); // Refresh maples
          } else {
            alert(data.error || 'Failed to subscribe.');
          }
        } catch (err) {
          alert('An error occurred. Please try again.');
        }
      }
      window.rate = function(coachId) {
        const rating = prompt('Rate out of 5');
        if (!rating) return;
        alert('Rated ' + coachId + ' as ' + rating);
      }

      // Pricing plan currency conversion
      const RATES = { USD:1, EUR:0.93, GBP:0.80, CAD:1.36 };
      const locale = navigator.language || 'en-US';
      const userCcy = new Intl.NumberFormat(locale,{style:'currency',currency:'USD'}).resolvedOptions().currency;
      document.querySelectorAll('.pricing-option').forEach(opt => {
        const usdEl = opt.querySelector('.price-usd');
        const localEl = opt.querySelector('.local-price');
        const usd = parseFloat(usdEl.dataset.usd);
        if (!usd || userCcy==='USD') return;
        const conv = usd * (RATES[userCcy]||1);
        localEl.textContent = ` (${new Intl.NumberFormat(locale,{style:'currency',currency:userCcy}).format(conv)})`;
      });

      // Load user profile picture and name
      async function loadUserProfilePic() {
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch(`${API_BASE}/api/user-profile`, { headers });
        if (!res.ok) return;
        const user = await res.json();
        let avatarUrl = 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png';
        if (user.avatar && user.discord_id) {
          avatarUrl = `https://cdn.discordapp.com/avatars/${user.discord_id}/${user.avatar}.png`;
        }
        document.getElementById('userProfilePic').src = avatarUrl;
        document.getElementById('userName').textContent = user.username || '';
      }
      if (token) loadUserProfilePic();

      // Initialize all data
      if (token) {
        loadCoaches();
        loadLeaderboard();
        loadStatus();
        loadShop();
      }

      document.getElementById('logoutBtn').addEventListener('click', function() {
        if (!confirm('Are you sure you want to log out?')) return;
        localStorage.removeItem('userToken');
        localStorage.removeItem('discordId');
        localStorage.removeItem('expectedPWA');
        window.location.href = '/';
      });

      // Add handler for top-right Reports button
      document.getElementById('reportsTopBtn').addEventListener('click', function() {
        handleTabClick('reports');
      });

      // Fetch and render weekly reports
      async function loadReports() {
        const container = document.getElementById('reportsContainer');
        container.textContent = 'Loading reports‚Ä¶';
        try {
          const res = await fetch(`/api/reports`, { headers: { Authorization: 'Bearer ' + token } });
          if (!res.ok) throw new Error('Failed to fetch reports');
          const reports = await res.json();
          if (!reports.length) {
            container.textContent = 'No reports yet.';
            return;
          }
          // Render reports as scrollable cards
          container.innerHTML = `<div style="display:flex;overflow-x:auto;gap:1rem;padding-bottom:1rem;">${reports.map(report => `
            <div style="min-width:320px;max-width:340px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:1rem;flex-shrink:0;display:flex;flex-direction:column;">
              <div style="font-weight:bold;font-size:1.1rem;margin-bottom:0.5rem;">Week ${report.weekNumber}, ${report.year}</div>
              <div style="margin-bottom:0.5rem;">
                <strong>Weekly Data:</strong>
                <pre style="background:#f6f8fa;padding:0.5rem;border-radius:4px;overflow-x:auto;font-size:0.95em;">${JSON.stringify(report.data, null, 2)}</pre>
              </div>
              <div style="margin-top:auto;">
                <strong>Coach Reviews:</strong>
                ${report.reviews && report.reviews.length ? report.reviews.map(r => `
                  <div style=\"margin:0.5em 0;padding:0.5em;background:#e6f7ff;border-radius:4px;\"><b>${r.coach_name}:</b> ${r.review}</div>
                `).join('') : '<div style="color:#888;">No reviews yet.</div>'}
              </div>
            </div>
          `).join('')}</div>`;
        } catch (err) {
          container.textContent = 'Failed to load reports.';
        }
      }

      // Load reports when Reports tab is activated
      document.querySelectorAll('[data-tab="reports"]').forEach(btn => {
        btn.addEventListener('click', loadReports);
      });

      // Hamburger menu logic for mobile
      const hamburgerMenuBtn = document.getElementById('hamburgerMenuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobilePlansBtn = document.getElementById('mobilePlansBtn');
      const mobileSettingsBtn = document.getElementById('mobileSettingsBtn');
      const mobileLeadersBtn = document.getElementById('mobileLeadersBtn');
      const mobileStatusBtn = document.getElementById('mobileStatusBtn');
      const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
      // Show/hide menu
      if (hamburgerMenuBtn && mobileMenu) {
        hamburgerMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          if (mobileMenu.style.display === 'flex') {
            mobileMenu.style.display = 'none';
          } else {
            mobileMenu.style.display = 'flex';
          }
        });
        // Hide menu when clicking outside
        document.addEventListener('click', function(e) {
          if (!mobileMenu.contains(e.target) && e.target !== hamburgerMenuBtn) {
            mobileMenu.style.display = 'none';
          }
        });
        // Hide menu on resize to desktop
        window.addEventListener('resize', function() {
          if (window.innerWidth > 768) {
            mobileMenu.style.display = 'none';
          }
        });
      }
      // Plans button logic
      if (mobilePlansBtn) {
        mobilePlansBtn.addEventListener('click', function() {
          mobileMenu.style.display = 'none';
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
          document.getElementById('plans').classList.add('active');
          // Set active state on navs
          document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => {
            if (btn.dataset.tab === 'plans') {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
        });
      }
      // Leaders button logic
      if (mobileLeadersBtn) {
        mobileLeadersBtn.addEventListener('click', function() {
          mobileMenu.style.display = 'none';
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
          document.getElementById('leaderboard').classList.add('active');
          // Set active state on navs
          document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => btn.classList.remove('active'));
        });
      }
      // Status button logic
      if (mobileStatusBtn) {
        mobileStatusBtn.addEventListener('click', function() {
          mobileMenu.style.display = 'none';
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
          document.getElementById('status').classList.add('active');
          // Set active state on navs
          document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => btn.classList.remove('active'));
        });
      }
      // Logout button logic
      if (mobileLogoutBtn) {
        mobileLogoutBtn.addEventListener('click', function() {
          if (!confirm('Are you sure you want to log out?')) return;
          localStorage.removeItem('userToken');
          localStorage.removeItem('discordId');
          localStorage.removeItem('expectedPWA');
          window.location.href = '/';
        });
      }
      // Settings button logic
      if (mobileSettingsBtn) {
        mobileSettingsBtn.addEventListener('click', function() {
          mobileMenu.style.display = 'none';
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
          document.getElementById('settings').classList.add('active');
          // Set active state on navs
          document.querySelectorAll('.dashboard-nav button, .mobile-bottom-nav button').forEach(btn => btn.classList.remove('active'));
        });
      }
      // Settings section logic
      const genderLabel = document.getElementById('genderLabel');
      function updateCharacterImage(gender) {
        // No longer update .character-img src, as it is a <video> now
      }
      async function loadUserGenderAndSetImage() {
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch('/api/user-profile', { headers });
        if (!res.ok) return;
        const user = await res.json();
        let gender = 'male';
        if (user.gender && user.gender.toLowerCase() === 'female') {
          gender = 'female';
        }
        genderLabel.textContent = gender.charAt(0).toUpperCase() + gender.slice(1);
        updateCharacterImage(gender);
      }
      if (token) loadUserGenderAndSetImage();

      // Claim New User XP logic
      const claimBtn = document.getElementById('claimNewUserXpBtn');
      if (claimBtn) {
        claimBtn.addEventListener('click', async function() {
          claimBtn.disabled = true;
          claimBtn.textContent = 'Claiming...';
          const headers = { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' };
          const res = await fetch('/api/claim-new-user-xp', { method: 'POST', headers });
          const data = await res.json();
          if (data.success && data.claimed) {
            document.getElementById('newUserReward').style.display = 'none';
            // Optionally reload status to update XP
            loadStatus();
          } else {
            claimBtn.disabled = false;
            claimBtn.textContent = 'Claim';
            alert('Could not claim reward.');
          }
        });
      }

      window.unsubscribe = async function(coachId) {
        if (!confirm('Are you sure you want to unsubscribe? Your money won\'t be refunded if you already have paid.')) return;
        try {
          const res = await fetch(`${API_BASE}/api/unsubscribe`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ coachId })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            alert('You have unsubscribed from this coach.');
            loadCoaches();
            loadStatus();
          } else {
            alert(data.error || 'Failed to unsubscribe.');
          }
        } catch (err) {
          alert('An error occurred. Please try again.');
        }
      }

      // Star rating event delegation
      document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('star')) {
          const span = e.target.closest('.star-rating');
          const coachId = span.getAttribute('data-coach');
          const value = Number(e.target.getAttribute('data-value'));
          // Highlight stars
          span.querySelectorAll('.star').forEach(star => {
            star.style.color = Number(star.getAttribute('data-value')) <= value ? '#f39c12' : '#ccc';
          });
          span.querySelector('.rate-label').textContent = `You rated ${value} star${value > 1 ? 's' : ''}`;
          // Send to backend
          const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
          try {
            const res = await fetch(`${API_BASE}/api/rate`, {
              method: 'POST',
              headers,
              body: JSON.stringify({ coachId, rating: value })
            });
            const data = await res.json();
            if (res.ok && data.success) {
              alert('Thank you for rating!');
              loadCoaches();
            } else {
              alert(data.error || 'Failed to rate coach.');
            }
          } catch (err) {
            alert('An error occurred. Please try again.');
          }
        }
      });

      // Place this after user data is loaded
      const CATEGORY_LABELS = {
        physical: 'Physical',
        mental: 'Mental',
        social: 'Social',
        love: 'Love',
        career: 'Career',
        creative: 'Creative',
        travel: 'Travel',
        family: 'Family',
        style: 'Style',
        spiritual: 'Spiritual'
      };
      let userCategoryData = {};

      // After fetching user data (in loadStatus or similar):
      // userCategoryData = { physical: 5, mental: 5, ... }

      // Attach click handlers after DOMContentLoaded and after user data is loaded
      function attachIconPopups() {
        document.querySelectorAll('.icon-circle').forEach(icon => {
          const cat = icon.getAttribute('data-category');
          const value = userCategoryData[cat] !== undefined ? userCategoryData[cat] : '-';
          const numValue = Number(value);
          let percent = 0;
          let ringColor = '#222';
          icon.classList.remove('black-smoky', 'left-popup', 'right-popup');
          if (icon.closest('.blue-bar.left')) {
            icon.classList.add('left-popup');
          } else if (icon.closest('.blue-bar.right')) {
            icon.classList.add('right-popup');
          }
          // For icon-circles inside .icon-scroll-container, always show popup to the right
          if (icon.closest('.icon-scroll-container')) {
            icon.classList.add('popup-right');
          }
          if (!isNaN(numValue) && numValue >= 0 && numValue <= 10) {
            percent = numValue / 10;
            if (numValue >= 8) {
              ringColor = 'gold';
            } else if (numValue >= 5) {
              ringColor = '#C0C0C0'; // Silver
              icon.classList.add('silver-glow');
            } else {
              ringColor = '#222';
              icon.classList.add('black-smoky');
            }
          }
          // Update both desktop and mobile ring bars
          icon.querySelectorAll('.ring-bar').forEach((ringBar, idx) => {
            const r = idx === 0 ? 60 : 22;
            const circumference = 2 * Math.PI * r;
            ringBar.setAttribute('stroke', ringColor);
            ringBar.setAttribute('stroke-dasharray', `${circumference * percent} ${circumference * (1 - percent)}`);
            ringBar.setAttribute('stroke-dashoffset', 0);
          });
          icon.onclick = function() {
            const label = CATEGORY_LABELS[cat] || cat;
            const popup = icon.querySelector('.popup');
            popup.textContent = `${label}: ${value}`;
            popup.style.display = 'block';
            setTimeout(() => { popup.style.display = 'none'; }, 2000);
          };
        });
      }

      const darkModeToggle = document.getElementById('darkModeToggle');
      if (darkModeToggle) {
        // Set initial state from localStorage
        if (localStorage.getItem('darkMode') === 'true') {
          document.body.classList.add('dark-mode');
          darkModeToggle.checked = true;
        }
        darkModeToggle.addEventListener('change', function() {
          if (this.checked) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'true');
          } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'false');
          }
        });
      }

      // Add loader for resources
      async function loadResources() {
        const headers = { Authorization: 'Bearer ' + token };
        const res = await fetch('/api/resources', { headers });
        const container = document.getElementById('resourcesContainer');
        if (!res.ok) {
          container.textContent = 'Failed to load resources.';
          return;
        }
        const resources = await res.json();
        if (!resources.length) {
          container.textContent = 'No resources available from your coaches yet.';
          return;
        }
        container.innerHTML = `<div class="resources-grid">${resources.map(resource => `
          <div class="resource-card">
            <div class="resource-header">
              <img class="resource-avatar" src="${resource.coach?.profile_picture || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png'}" alt="Coach">
              <div class="resource-coach-info">
                <div class="resource-coach-name">${resource.coach?.name || 'Coach'}</div>
                <div class="resource-title">${resource.title || 'Untitled Video'}</div>
              </div>
            </div>
            <div class="resource-description">${resource.description || ''}</div>
            <div class="resource-video-wrapper">
              <iframe src="https://player.mux.com/${resource.muxPlaybackId}" style="width: 100%; border: none; aspect-ratio: 1/1;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen></iframe>
            </div>
          </div>
        `).join('')}</div>`;
      }

      // Google Analytics event tracking for all major buttons
      function trackButtonClick(label) {
        let userId = localStorage.getItem('discordId') || localStorage.getItem('userToken') || undefined;
        gtag('event', 'button_click', {
          'event_category': 'User Dashboard',
          'event_label': label,
          'user_id': userId,
          'page_location': window.location.pathname
        });
      }
      // Attach tracking to nav buttons
      ['explore','rewards','leaderboard','status','plans','reports','home','settings'].forEach(id => {
        document.querySelectorAll(`[data-tab="${id}"]`).forEach(btn => {
          btn.addEventListener('click',()=>trackButtonClick(id));
        });
        if(document.getElementById(id)){
          document.getElementById(id).addEventListener('click',()=>trackButtonClick(id));
        }
      });
      // Other key buttons
      if(document.getElementById('claimNewUserXpBtn')){
        document.getElementById('claimNewUserXpBtn').addEventListener('click',()=>trackButtonClick('claimNewUserXpBtn'));
      }
      if(document.getElementById('logoutBtn')){
        document.getElementById('logoutBtn').addEventListener('click',()=>trackButtonClick('logoutBtn'));
      }
      if(document.getElementById('loginBtn')){
        document.getElementById('loginBtn').addEventListener('click',()=>trackButtonClick('loginBtn'));
      }
      if(document.getElementById('installAppBtn')){
        document.getElementById('installAppBtn').addEventListener('click',()=>trackButtonClick('installAppBtn'));
      }
      // PayPal buttons (if you want to track clicks on the containers)
      ['paypal-button-container-1','paypal-button-container-2','paypal-button-container-3','paypal-button-container-maples'].forEach(id=>{
        if(document.getElementById(id)){
          document.getElementById(id).addEventListener('click',()=>trackButtonClick(id));
        }
      });

      // Tile Journey logic for Home tab
      (function(){
        const tileGrid = document.getElementById('tileGrid');
        const messagePanel = {
          title: document.getElementById('tileTitle'),
          message: document.getElementById('tileMessage'),
          perk: document.getElementById('tilePerk'),
        };
        const popupNotification = document.getElementById('popupNotification');
        const popupMessage = document.getElementById('popupMessage');
        const storySegments = [
          {message:"You found a mysterious key lying on the path.", perk:"New path unlocked"},
          {message:"A stranger offers you a cryptic warning.", perk:"Be cautious ahead"},
          {message:"You discovered an old, weathered map.", perk:"Hint to hidden treasures"},
          {message:"You help a lost traveler find their way.", perk:"Earn kindness badge"},
          {message:"A frightening storm slows your journey.", perk:"Endure and gain resilience"},
          {message:"A beautiful sunrise fills you with hope.", perk:"Energy restored"},
          {message:"You stumble upon a treasure chest.", perk:"Gain 200 Coins"},
          {message:"An unexpected riddle blocks your path.", perk:"Solve it to proceed"},
          {message:"You make a memorable friend on the road.", perk:"Companionship bonus"},
          {message:"You narrowly avoid a dangerous trap.", perk:"Cautious steps rewarded"},
          {message:"You find a fragrant flower with healing properties.", perk:"Health restored"},
          {message:"You are invited to a festive celebration.", perk:"Receive a luck charm"},
          {message:"You learn a new skill from a wise mentor.", perk:"Skill points gained"},
          {message:"You cross an ancient bridge with tales untold.", perk:"Discover hidden lore"},
          {message:"You rescue a stranded animal.", perk:"Compassion rewarded"},
          {message:"You find a secret passage through the forest.", perk:"Shortcut gained"},
          {message:"A sudden challenge tests your strength.", perk:"Earn stamina boost"},
          {message:"You camp under a sky full of stars.", perk:"Peaceful rest granted"},
          {message:"You barter successfully at a bustling market.", perk:"Extra coins earned"},
          {message:"You solve a mystery from the past.", perk:"Unlock new storyline"},
          {message:"You face a rival in a friendly contest.", perk:"Respect earned"},
          {message:"You find a rare gemstone shining bright.", perk:"Valuable treasure"},
          {message:"You mend broken equipment.", perk:"Gear improved"},
          {message:"You share a story with villagers.", perk:"Community spirit gained"},
          {message:"You reach a crossroads full of possibilities.", perk:"Choose your next quest"}
        ];
        const tileCount = 25;
        function createTiles(pos) {
          tileGrid.innerHTML = '';
          for(let i = 0; i < tileCount; i++){
            const div = document.createElement('div');
            div.className = 'tile';
            div.setAttribute('role', 'gridcell');
            div.setAttribute('data-index', i);
            div.innerHTML = '<div style="width:14px;height:14px;background:rgba(255,255,255,0.4);border-radius:50%;box-shadow: inset 0 0 6px white;"></div>';
            if (i === pos) {
              div.classList.add('active');
              // Character icon inside the tile
              div.innerHTML = '<div style="width:40px;height:40px;background:#e94e77;border-radius:50%;border:3px solid #fff;box-shadow:0 0 12px #e94e77,0 0 10px #e94e77;display:flex;align-items:center;justify-content:center;font-size:1.6rem;color:#fff;margin:0 auto;">&#x1F9D6;</div>';
            }
            tileGrid.appendChild(div);
          }
        }
        function getDateString(){
          const now = new Date();
          return now.getFullYear().toString().padStart(4,'0') +
            (now.getMonth()+1).toString().padStart(2,'0') +
            now.getDate().toString().padStart(2,'0');
        }
        function getSavedData(){
          let pos = localStorage.getItem('tile-game-position');
          let savedDate = localStorage.getItem('tile-game-date');
          let storyIndex = localStorage.getItem('tile-game-story-index');
          return {
            pos: pos !== null ? parseInt(pos,10) : 0,
            savedDate: savedDate || null,
            storyIndex: storyIndex !== null ? parseInt(storyIndex,10) : 0
          };
        }
        function saveData(pos, storyIndex){
          localStorage.setItem('tile-game-position', pos);
          localStorage.setItem('tile-game-date', getDateString());
          localStorage.setItem('tile-game-story-index', storyIndex);
        }
        function showPopup(message, perk){
          if (!popupNotification) return;
          popupMessage.textContent = message + " ‚Äî " + perk;
          popupNotification.style.display = 'flex';
          popupNotification.classList.add('show');
          setTimeout(() => {
            popupNotification.classList.remove('show');
            popupNotification.style.display = 'none';
          }, 4800);
        }
        function updateMessagePanel(message, perk){
          messagePanel.title.textContent = "Your Story";
          messagePanel.message.textContent = message;
          messagePanel.perk.textContent = perk;
        }
        function init(){
          const { pos, savedDate, storyIndex } = getSavedData();
          const today = getDateString();
          let newPos = pos;
          let newStoryIndex = storyIndex;
          if(savedDate !== today){
            newPos = (pos + 1) % tileCount;
            newStoryIndex = (storyIndex + 1) % storySegments.length;
            saveData(newPos, newStoryIndex);
            createTiles(newPos);
            const segment = storySegments[newStoryIndex];
            updateMessagePanel(segment.message, segment.perk);
            setTimeout(() => { showPopup(segment.message, segment.perk); }, 650);
          } else {
            createTiles(pos);
            const segment = storySegments[newStoryIndex];
            updateMessagePanel(segment.message, segment.perk);
          }
        }
        window.addEventListener('load', () => {
          setTimeout(init, 120);
        });
      })();
    });
  </script>

  <!-- Add mobile bottom nav -->
  <nav class="mobile-bottom-nav">
    <button data-tab="explore"><i class="ph ph-magnifying-glass icon-minimal"></i><div>Coaches</div></button>
    <button data-tab="rewards"><i class="ph ph-gift icon-minimal"></i><div>Rewards</div></button>
    <button data-tab="home"><i class="ph ph-house icon-minimal"></i><div>Home</div></button>
    <button data-tab="resources"><i class="ph ph-play-circle icon-minimal"></i><div>Resources</div></button>
    <button data-tab="reports"><i class="ph ph-file-text icon-minimal"></i><div>Reports</div></button>
  </nav>

  <style>
    .ring-svg-mobile { display: none; }
    @media (max-width: 600px) {
      .ring-svg-desktop { display: none !important; }
      .ring-svg-mobile { display: block !important; }
    }
    /* Resources Tab Styles */
    .resources-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5em;
      margin-top: 1em;
    }
    @media (min-width: 700px) {
      .resources-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .resource-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 1.2em 1.2em 1em 1.2em;
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      border: 1px solid #f0f0f0;
    }
    .resource-header {
      display: flex;
      align-items: center;
      gap: 0.9em;
    }
    .resource-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #eee;
      background: #fafbfc;
    }
    .resource-coach-info {
      display: flex;
      flex-direction: column;
      gap: 0.1em;
    }
    .resource-coach-name {
      font-weight: 600;
      font-size: 1.08em;
      color: #222;
    }
    .resource-title {
      font-size: 1em;
      color: #008cba;
      font-weight: 500;
      margin-top: 2px;
    }
    .resource-description {
      color: #444;
      font-size: 0.98em;
      margin-bottom: 0.2em;
    }
    .resource-video-wrapper {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 12px;
      background: #000;
    }
    .resource-video-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
    }
    .progress-bar-energy {
      height: 16px;
      border-radius: 8px;
      background: #ffd600;
      transition: width 0.4s;
    }
    @media (max-width: 600px) {
      #three-canvas.character-img {
        max-width: 90vw !important;
        min-width: 80px !important;
        height: 180px !important;
        max-height: 220px !important;
      }
    }
    /* Custom notification prompt styles */
    #custom-notify-prompt {
      display: none;
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px #0002;
      padding: 2em 2.2em 1.7em 2.2em;
      z-index: 9999;
      min-width: 320px;
      max-width: 90vw;
      text-align: center;
      animation: fadeInUp 0.5s;
    }
    #custom-notify-prompt .notify-icon {
      font-size: 2.8em;
      margin-bottom: 0.5em;
      display: block;
    }
    #custom-notify-prompt .notify-title {
      font-size: 1.25em;
      font-weight: bold;
      margin-bottom: 0.4em;
      color: #008cba;
    }
    #custom-notify-prompt .notify-desc {
      font-size: 1.05em;
      color: #444;
      margin-bottom: 1.2em;
    }
    #custom-notify-prompt .notify-btn {
      background: linear-gradient(90deg, #f78270, #feb57c);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.8em 2em;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #f7827033;
      transition: background 0.2s;
    }
    #custom-notify-prompt .notify-btn:hover {
      background: linear-gradient(90deg, #feb57c, #f78270);
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  <script type="module" src="js/main.js"></script>
  <!-- Import Decision Helper UI -->
  <script type="module" src="js/decision-helper-ui.js"></script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
  </script>
  <div id="custom-notify-prompt">
    <span class="notify-icon">üèÜ</span>
    <div class="notify-title">Level Up Notifications</div>
    <div class="notify-desc">Get notified instantly when your character achieves a new level!</div>
    <button class="notify-btn" id="enable-notifications-btn">Enable Notifications</button>
  </div>
</body>
</html>
