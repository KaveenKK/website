<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YR1B2Z51N0"></script>
  <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'G-YR1B2Z51N0');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="Unlock the All-Rounder - Your personal development platform" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="images/glowinglogonowback.webp" />
  <title>Nevengi</title>
  <link rel="stylesheet" href="styles.css">

  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New content is available, refresh the page
                  window.location.reload();
                }
              });
            });
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    // Check for existing tokens and redirect if logged in
    console.log('Checking authentication status...');
    
    // Check URL parameters first
    const params = new URLSearchParams(window.location.search);
    const urlUserToken = params.get('token');
    const urlDiscordId = params.get('discord_id');
    const urlCoachToken = params.get('coachToken');
    const oauthCode = params.get('code');
    const oauthState = params.get('state');
    
    // If we have an OAuth code, handle it directly without service worker
    if (oauthCode && oauthState) {
      console.log('OAuth flow detected, processing...');
      // Clear any existing tokens
      localStorage.removeItem('userToken');
      localStorage.removeItem('coachToken');
      localStorage.removeItem('discordId');
      
      // Get the original auth URL from state
      const authType = oauthState.split('_')[0]; // 'user' or 'coach'
      const authUrl = `/auth/discord/${authType}`;
      
      // Make the token request directly
      fetch(`${authUrl}?code=${oauthCode}&state=${oauthState}`, {
        method: 'GET',
        headers: {
          'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Auth request failed');
        }
        return response.json();
      })
      .then(data => {
        if (data.token) {
          // Store the token and redirect
          if (authType === 'user') {
            localStorage.setItem('userToken', data.token);
            if (data.discord_id) {
              localStorage.setItem('discordId', data.discord_id);
            }
            window.location.href = '/user_dashboard.html';
          } else {
            localStorage.setItem('coachToken', data.token);
            window.location.href = '/coach_dashboard.html';
          }
        } else {
          throw new Error('No token received');
        }
      })
      .catch(error => {
        console.error('Auth error:', error);
        // Clear any partial state
        localStorage.removeItem('userToken');
        localStorage.removeItem('coachToken');
        localStorage.removeItem('discordId');
        // Redirect to home page
        window.location.href = '/';
      });
      return;
    }
    
    // Check localStorage
    const storedUserToken = localStorage.getItem('userToken');
    const storedCoachToken = localStorage.getItem('coachToken');
    
    console.log('URL User Token:', urlUserToken ? 'exists' : 'not found');
    console.log('URL Discord ID:', urlDiscordId ? 'exists' : 'not found');
    console.log('URL Coach Token:', urlCoachToken ? 'exists' : 'not found');
    console.log('Stored User Token:', storedUserToken ? 'exists' : 'not found');
    console.log('Stored Coach Token:', storedCoachToken ? 'exists' : 'not found');
    
    // Function to validate token
    async function validateToken(token, type) {
      try {
        const response = await fetch(`/api/auth/validate-${type}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        return response.ok;
      } catch (error) {
        console.error(`Error validating ${type} token:`, error);
        return false;
      }
    }

    // Function to handle redirection
    async function handleRedirection() {
      // If we have a coach token in URL, it takes highest priority
      if (urlCoachToken) {
        console.log('Storing coach token from URL...');
        localStorage.setItem('coachToken', urlCoachToken);
        localStorage.removeItem('userToken'); // Clear any user token
        history.replaceState({}, '', window.location.pathname);
        console.log('Redirecting to coach dashboard...');
        window.location.href = '/coach_dashboard.html';
        return;
      }

      // If we have a stored coach token, validate it
      if (storedCoachToken) {
        const isValid = await validateToken(storedCoachToken, 'coach');
        if (isValid) {
          console.log('Redirecting to coach dashboard using stored token...');
          window.location.href = '/coach_dashboard.html';
          return;
        } else {
          console.log('Invalid coach token, clearing...');
          localStorage.removeItem('coachToken');
        }
      }

      // If we have a user token in URL, handle it
      if (urlUserToken) {
        console.log('Storing user token from URL...');
        localStorage.setItem('userToken', urlUserToken);
        if (urlDiscordId) {
          localStorage.setItem('discordId', urlDiscordId);
        }
        history.replaceState({}, '', window.location.pathname);
        console.log('Redirecting to user dashboard...');
        window.location.href = '/user_dashboard.html';
        return;
      }

      // If we have a stored user token, validate it
      if (storedUserToken) {
        const isValid = await validateToken(storedUserToken, 'user');
        if (isValid) {
          console.log('Redirecting to user dashboard using stored token...');
          window.location.href = '/user_dashboard.html';
          return;
        } else {
          console.log('Invalid user token, clearing...');
          localStorage.removeItem('userToken');
        }
      }
    }

    // Execute the redirection logic
    handleRedirection();
  </script>
</head>
<body>

  <header>
    <div class="glass">
      <div class="logo">
        <a href="/" class="logo-link">
          <img src="images/glowinglogonowback.webp" alt="Nevengi" class="logo-img" />
          <span class="logo-text">Nevengi™</span>
        </a>
      </div>
      <nav>
        <a href="https://nevengi-research-center.super.site/" target="_blank" rel="noopener noreferrer">
          <button>NRC</button>
        </a>
        
        <div class="login-wrapper">
          <a href="#" id="login-link">Login</a>
          <div id="login-menu">
            <button onclick="location.href='/auth/discord/user'">
                <img src="images/colombian.gif" alt="User Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                User Login
            </button>
              
            <button onclick="location.href='/auth/discord'">
                <img src="images/mentorship.gif" alt="Coach Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                Coach Login
            </button>
              
          </div>
        </div>
      </nav>
    </div>
  </header>

    <!-- Scrollable Feature Cards -->
  <section class="scroll-container">
    <div class="card-scroll">
      <img src="images/coach tranforamtion.png" alt="feature 1" />
      <p>Become a coach for your own followers</p>
    </div>

    <div class="card-scroll">
      <img src="images/18plus.webp" alt="feature 1" />
      <p>Are You 18 or Older ?</p>
    </div>
    <div class="card-scroll">
      <img src="images/followers.webp" alt="Feature 2" />
      <p>Do You have more than 5k followers in any of your social media accounts ?</p>
    </div>
    <div class="card-scroll">
      <img src="images/niche.webp" alt="Feature 3" />
      <p>Do you make content for a specific niche ?</p>
    </div>
    <div class="card-scroll">
      <img src="images/accountability.webp" alt="Feature 4" />
      <p>Being Accountable</p>
    </div>
    <div class="card-scroll">
      <img src="images/advice.webp" alt="Feature 5" />
      <p>Giving Advice</p>
    </div>
    <div class="card-scroll">
      <img src="images/socialmediacontent.webp" alt="Feature 6" />
      <p>Create content to get your followers to Nevengi</p>
    </div>
  </section>

  <section class="hero glass" id="hero">
    <!-- Hero Intro -->
    <div class="hero-text" id="hero-text">
      <h1>Unlock the<br> All-Rounder.</h1><br>
      <p>Tired of saving quotes and watching motivational videos?<br>
        It's time to stop dreaming and get practical.<br>
        <br>
        <p><b> Already have a follow base ?</b> Join Nevengi as an<b> Content Creator</b> & Earn While you help people</p>
        Unlock the All-Rounder.</p>
      <button class="btn-primary" id="start-btn">Get Started</button>
      <button class="btn-primary" id="install-btn" style="margin-top: 10px;">Install App</button>
    </div>
    <div class="hero-img" id="hero-img">
      <img src="images/mascot.webp" alt="Nevengi Character" />
    </div>

    <!-- Embedded Questionnaire -->
    <div id="questionnaire" class="glass"></div>
  </section>

  <!-- =========  FAQ  ===================================================== -->
<section id="faq" class="faq glass">
  <h2 class="faq-heading">Frequently Asked Questions</h2>

  <!-- ── Coaches ──────────────────────────────────────────────────────── -->
  <div class="faq-category">
    <h3 class="faq-subheading">For Coaches</h3>

    <details>
      <summary>How do I earn money with Nevengi?</summary>
      <p>You set your own monthly subscription price for followers.  
         Each time a user subscribes, funds are split automatically—80 % goes to you, the rest covers platform and payment-processing fees.</p>
    </details>

    <details>
      <summary>How long does it take to start earning?</summary>
      <p>As soon as your coaching profile is approved (typically within 24-48 hours) and you list a paid program, subscribers can start joining—so earnings can begin right away.</p>
    </details>

    <details>
      <summary>When will I get paid?</summary>
      <p>Payouts are processed every Friday. You'll receive funds in your connected account 5-7 business days after each payout run.</p>
    </details>
  </div>

  <!-- ── Users ─────────────────────────────────────────────────────────── -->
  <div class="faq-category">
    <h3 class="faq-subheading">For Users</h3>

    <details>
      <summary>How many coaches can I subscribe to at once?</summary>
      <p>You can keep up to <strong>five</strong> active coach subscriptions simultaneously. You're free to cancel or swap any of them each month.</p>
    </details>

    <details>
      <summary>What does my subscription include?</summary>
      <p>Access to your coach's daily challenges, direct messaging, progress tracking and exclusive Discord channels. Some coaches add bonus perks like live Q&amp;A calls or downloadable resources.</p>
    </details>
  </div>
</section>


  <!-- footer start -->
  <footer class="footer glass">
    <div class="footer-container">
      <!-- 1. Brand & copyright -->
      <div class="footer-col footer-brand">
        <p>© 2025 Nevengi. All Rights Reserved.</p>
      </div>

  <script>
    const discordLink = 'https://discord.gg/SYtbqPMqju';
    const startBtn = document.getElementById('start-btn');
    const questionnaire = document.getElementById('questionnaire');
    const heroText = document.getElementById('hero-text');
    const heroImg = document.getElementById('hero-img');

    const questions = [
      {
        text: 'Who are you?',
        options: [
          { label: 'I am a user', 
            img: 'images/usernobk.png',
            action: () => showUserMessage()
          },  
          { 
            label: 'I am an influencer',
            img: 'images/coachnobk.png',
            next: 1 
          },
          { 
            label: 'Startup/ Company',
            img: 'images/coachnobk.png',
            action: () => showCompanyMessage()
          },
        ]
      },
      {
        text: 'Do you have 5000+ followers on any platform?',
        options: [
          { label: 'Yes, I do',
            img: 'images/happymascot.webp',
            action: () => window.location.href = '/introduction_coaching.html' 
          },
          {
            label: 'No, not yet',
            img: 'images/sadmascot2d.png',
            action: () => showFinalUserMessage() 
          }
        ]
      }
    ];

    


    let currentIndex = null;

    function showUserMessage() {
      questionnaire.innerHTML = `
       <button class="back-btn" onclick="goBack()">← Back</button><br>
       <img class="question-img" src="images/manthink.jpg" alt="Welcome" />
       <h2>You were told to be strong, work hard, stay confident, and never give up.🤦‍♂️</h2>
       <p> But did any of those surface-level tips actually help you take action? Everyone knows these things🤷‍♂️. what we need is a practical system. That's exactly why we built Nevengi.</p>
       <button class="btn-primary" onclick="showFinalUserMessage()">Yeah, makes sense</button>
     `;
   }


    function showQuestion(index) {
      currentIndex = index;
      // instantly hide hero intro
      heroText.classList.add('hidden');
      heroImg.classList.add('hidden');
      // show questionnaire
      questionnaire.style.display = 'block';

      const q = questions[index];
      questionnaire.innerHTML = `
        <button class="back-btn" onclick="goBack()">← Back</button>
        <h2>${q.text}</h2>
        <div class="options-row">
          ${q.options.map((opt, i) => `
            <button class="option glass" onclick="handleOptionClick(${index}, ${i})">
              <img class="option-img" src="${opt.img}" alt="" />
              <span>${opt.label}</span>
            </button>
          `).join('')}
        </div>
      `;
    }

    function handleOptionClick(qIndex, oIndex) {
      const opt = questions[qIndex].options[oIndex];
      if (opt.hasOwnProperty('next')) {
        const next = opt.next;
        if (next < questions.length) {
          showQuestion(next);
        } else {
          showFinalUserMessage();
        }
      } else if (opt.action) {
        opt.action();
      }
    }

    function showFinalUserMessage() {
      questionnaire.innerHTML = `
        <button class="back-btn" onclick="goBack()">← Back</button><br>
        <img class="question-img" src="images/mylogo_nevengi_circle.webp" alt="Welcome" />
        <h2>Welcome to Nevengi!</h2>
        <p>Join a powerful community of self-improvers and access daily challenges, rewards, and coaching support to transform your life.</p><br>
        <a href="${discordLink}" class="btn-primary">Join our Discord</a>
      `;
    }

    function showCompanyMessage() {
      questionnaire.innerHTML = `
        <button class="back-btn" onclick="goBack()">← Back</button><br>
        <h2 style="text-align: center;">Support your employees' growth 🚀</h2>
        <img class="question-img" src="images/companyoffer.png" alt="Company Offer" style="width: 250px; max-width: 100%; height: auto; display: block; margin: 0 auto;" />
        <br>
        <div style="text-align: left; padding: 0 20px;">
        <p>⚡Offer your employees free access to Nevengi's self-improvement system and watch them grow stronger, smarter, and more productive.</p>
        <p><strong>Minimum:</strong> 6 months per employee</p><br>
        <p>To get started, email us at <a href="mailto:nevengiteam@gmail.com">team@nevengi.com</a> with:</p>
        <p><strong>📌Number of employees</p>
        <p><strong>📌 Time period:</strong> How long will they have access? (Minimum 6 months)</p><br>
        <p>We'll get back to you within 24 hours with a quote</p><br>
        <div style="text-align: center;">
         <a href="mailto:nevengiteam@gmail.com" class="btn-primary">Contact Us Now</a>
        </div>

     `;
    }


    function goBack() {
      if (currentIndex === 0) {
        // back to welcome
        questionnaire.style.display = 'none';
        heroText.classList.remove('hidden');
        heroImg.classList.remove('hidden');
        currentIndex = null;
      } else if (currentIndex > 0) {
        showQuestion(currentIndex - 1);
      }
    }

    // Login menu toggle
    document.getElementById('login-link').addEventListener('click', e => {
      e.preventDefault();
      const menu = document.getElementById('login-menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', e => {
      const menu = document.getElementById('login-menu');
      if (!menu.contains(e.target) && e.target.id !== 'login-link') {
        menu.style.display = 'none';
      }
    });

    // Start questionnaire
    startBtn.addEventListener('click', () => showQuestion(0));

    // Add this to your existing script section
    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');
    
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent Chrome 67 and earlier from automatically showing the prompt
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      // Show the install button
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) {
        alert('App is already installed or not available for installation');
        return;
      }
      // Show the install prompt
      deferredPrompt.prompt();
      // Wait for the user to respond to the prompt
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        console.log('User accepted the install prompt');
      } else {
        console.log('User dismissed the install prompt');
      }
      // Clear the saved prompt since it can't be used again
      deferredPrompt = null;
      // Hide the install button
      installBtn.style.display = 'none';
    });

    window.addEventListener('appinstalled', (evt) => {
      console.log('App was installed');
      installBtn.style.display = 'none';
    });

    // Add event listener for beforeunload to ensure tokens are preserved
    window.addEventListener('beforeunload', () => {
      // Force a sync write to localStorage
      localStorage.setItem('lastVisit', Date.now().toString());
    });
  </script>
</body>
</html>
