<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YR1B2Z51N0"></script>
  <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'G-YR1B2Z51N0');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="Unlock the All-Rounder - Your personal development platform" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="images/glowinglogonowback.webp" />
  <title>Nevengi</title>
  <link rel="stylesheet" href="styles.css">

  <script>
    // Global variables
    const discordLink = 'https://discord.gg/SYtbqPMqju';
    const startBtn = document.getElementById('start-btn');
    const questionnaire = document.getElementById('questionnaire');
    const heroText = document.getElementById('hero-text');
    const heroImg = document.getElementById('hero-img');
    const installBtn = document.getElementById('install-btn');
    let deferredPrompt;
    let currentIndex = null;

    const questions = [
      {
        text: 'Who are you?',
        options: [
          { label: 'I am a user', 
            img: 'images/usernobk.png',
            action: () => showUserMessage()
          },  
          { 
            label: 'I am an influencer',
            img: 'images/coachnobk.png',
            next: 1 
          },
          { 
            label: 'Startup/ Company',
            img: 'images/coachnobk.png',
            action: () => showCompanyMessage()
          },
        ]
      },
      {
        text: 'Do you have 5000+ followers on any platform?',
        options: [
          { label: 'Yes, I do',
            img: 'images/happymascot.webp',
            action: () => window.location.href = '/introduction_coaching.html' 
          },
          {
            label: 'No, not yet',
            img: 'images/sadmascot2d.png',
            action: () => showFinalUserMessage() 
          }
        ]
      }
    ];

    // Check if we're in a PWA context
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                 window.navigator.standalone || 
                 document.referrer.includes('android-app://');

    // OAuth state management
    const oauthState = {
      processing: false,
      processedCodes: new Set(),
      lastAttempt: 0,
      retryCount: 0
    };

    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New content is available, refresh the page
                  window.location.reload();
                }
              });
            });
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    // Add this to ensure auth endpoints are not cached
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', event => {
        if (event.data && event.data.type === 'SKIP_WAITING') {
          navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
        }
      });
    }

    // Check for existing tokens and redirect if logged in
    console.log('Checking authentication status...');
    
    // Check URL parameters first
    const params = new URLSearchParams(window.location.search);
    const urlUserToken = params.get('token');
    const urlDiscordId = params.get('discord_id');
    const urlCoachToken = params.get('coachToken');
    const oauthCode = params.get('code');
    const oauthStateParam = params.get('state');
    const isPwaAuth = params.get('pwa') === 'true';
    
    // If we have an OAuth code, handle it directly
    if (oauthCode && oauthStateParam && !oauthState.processing) {
      // Check if we've already processed this code
      if (oauthState.processedCodes.has(oauthCode)) {
        console.log('OAuth code already processed, ignoring...');
        return;
      }

      // Check rate limiting
      const now = Date.now();
      const timeSinceLastAttempt = now - oauthState.lastAttempt;
      if (timeSinceLastAttempt < 5000) { // 5 second cooldown
        console.log('Rate limit cooldown, please wait...');
        setTimeout(() => {
          window.location.reload();
        }, 5000 - timeSinceLastAttempt);
        return;
      }

      console.log('OAuth flow detected, processing...');
      oauthState.processing = true;
      oauthState.lastAttempt = now;
      oauthState.processedCodes.add(oauthCode);
      
      // Clear any existing tokens
      localStorage.removeItem('userToken');
      localStorage.removeItem('coachToken');
      localStorage.removeItem('discordId');
      
      // Get the original auth URL from state
      const authType = oauthStateParam.split('_')[0]; // 'user' or 'coach'
      const authUrl = `/auth/discord/${authType}`;
      
      // For PWA, we need to handle the OAuth flow differently
      if (isPWA || isPwaAuth) {
        console.log('PWA context detected, using alternative OAuth flow');
        
        // If this is a PWA auth attempt, wait a bit before proceeding
        if (isPwaAuth) {
          setTimeout(() => {
            // Unregister service worker during OAuth
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => registration.unregister());
              });
            }
            
            // Make the token request directly
            fetch(`${authUrl}?code=${oauthCode}&state=${oauthStateParam}&timestamp=${now}&pwa=true`, {
              method: 'GET',
              headers: {
                'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
              }
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Auth request failed');
              }
              return response.json();
            })
            .then(data => {
              if (data.token) {
                // Store the token and redirect
                if (authType === 'user') {
                  localStorage.setItem('userToken', data.token);
                  if (data.discord_id) {
                    localStorage.setItem('discordId', data.discord_id);
                  }
                  window.location.href = '/user_dashboard.html';
                } else {
                  localStorage.setItem('coachToken', data.token);
                  window.location.href = '/coach_dashboard.html';
                }
              } else {
                throw new Error('No token received');
              }
            })
            .catch(error => {
              console.error('Auth error:', error);
              // Clear any partial state
              localStorage.removeItem('userToken');
              localStorage.removeItem('coachToken');
              localStorage.removeItem('discordId');
              // Redirect to home page
              window.location.href = '/';
            })
            .finally(() => {
              oauthState.processing = false;
            });
          }, 2000); // Wait 2 seconds before making the request
        } else {
          // Initial PWA redirect
          window.location.href = `${authUrl}?code=${oauthCode}&state=${oauthStateParam}&pwa=true&timestamp=${now}`;
        }
        return;
      }
      
      // Regular web flow
      fetch(`${authUrl}?code=${oauthCode}&state=${oauthStateParam}&timestamp=${now}`, {
        method: 'GET',
        headers: {
          'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Auth request failed');
        }
        return response.json();
      })
      .then(data => {
        if (data.token) {
          // Store the token and redirect
          if (authType === 'user') {
            localStorage.setItem('userToken', data.token);
            if (data.discord_id) {
              localStorage.setItem('discordId', data.discord_id);
            }
            window.location.href = '/user_dashboard.html';
          } else {
            localStorage.setItem('coachToken', data.token);
            window.location.href = '/coach_dashboard.html';
          }
        } else {
          throw new Error('No token received');
        }
      })
      .catch(error => {
        console.error('Auth error:', error);
        // Clear any partial state
        localStorage.removeItem('userToken');
        localStorage.removeItem('coachToken');
        localStorage.removeItem('discordId');
        // Redirect to home page
        window.location.href = '/';
      })
      .finally(() => {
        oauthState.processing = false;
      });
      return;
    }
    
    // Check localStorage
    const storedUserToken = localStorage.getItem('userToken');
    const storedCoachToken = localStorage.getItem('coachToken');
    
    console.log('URL User Token:', urlUserToken ? 'exists' : 'not found');
    console.log('URL Discord ID:', urlDiscordId ? 'exists' : 'not found');
    console.log('URL Coach Token:', urlCoachToken ? 'exists' : 'not found');
    console.log('Stored User Token:', storedUserToken ? 'exists' : 'not found');
    console.log('Stored Coach Token:', storedCoachToken ? 'exists' : 'not found');
    
    // Function to validate token
    async function validateToken(token, type) {
      console.log(`Validating ${type} token:`, token);
      if (!token) {
        console.log('No token provided for validation');
        return false;
      }
      
      try {
        const response = await fetch(`/auth/validate-${type}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0',
            'X-Requested-With': 'XMLHttpRequest' // Prevent caching
          },
          credentials: 'include' // Include cookies if any
        });
        
        console.log(`Validation response for ${type}:`, response.status);
        if (!response.ok) {
          console.log(`Token validation failed for ${type}:`, response.status);
          // Clear invalid token
          if (type === 'user') {
            localStorage.removeItem('userToken');
          } else {
            localStorage.removeItem('coachToken');
          }
          return false;
        }
        
        const data = await response.json();
        console.log(`Validation data for ${type}:`, data);
        return data.valid === true;
      } catch (error) {
        console.error(`Error validating ${type} token:`, error);
        // Clear token on error
        if (type === 'user') {
          localStorage.removeItem('userToken');
        } else {
          localStorage.removeItem('coachToken');
        }
        return false;
      }
    }

    // Function to handle redirection
    async function handleRedirection() {
      console.log('Starting redirection check...');
      
      // Clear URL parameters after processing
      const clearUrlParams = () => {
        if (window.location.search) {
          history.replaceState({}, '', window.location.pathname);
        }
      };

      // If we have a coach token in URL, it takes highest priority
      if (urlCoachToken) {
        console.log('Found coach token in URL, storing and redirecting...');
        localStorage.setItem('coachToken', urlCoachToken);
        localStorage.removeItem('userToken'); // Clear any user token
        clearUrlParams();
        window.location.href = '/coach_dashboard.html';
        return;
      }

      // If we have a stored coach token, validate it
      if (storedCoachToken) {
        console.log('Found stored coach token, validating...');
        try {
          const isValid = await validateToken(storedCoachToken, 'coach');
          if (isValid) {
            console.log('Coach token valid, redirecting to coach dashboard...');
            window.location.href = '/coach_dashboard.html';
            return;
          } else {
            console.log('Invalid coach token, clearing...');
            localStorage.removeItem('coachToken');
          }
        } catch (error) {
          console.error('Error validating coach token:', error);
          localStorage.removeItem('coachToken');
        }
      }

      // If we have a user token in URL, handle it
      if (urlUserToken) {
        console.log('Found user token in URL, storing and redirecting...');
        localStorage.setItem('userToken', urlUserToken);
        if (urlDiscordId) {
          localStorage.setItem('discordId', urlDiscordId);
        }
        clearUrlParams();
        window.location.href = '/user_dashboard.html';
        return;
      }

      // If we have a stored user token, validate it
      if (storedUserToken) {
        console.log('Found stored user token, validating...');
        try {
          const isValid = await validateToken(storedUserToken, 'user');
          if (isValid) {
            console.log('User token valid, redirecting to user dashboard...');
            window.location.href = '/user_dashboard.html';
            return;
          } else {
            console.log('Invalid user token, clearing...');
            localStorage.removeItem('userToken');
          }
        } catch (error) {
          console.error('Error validating user token:', error);
          localStorage.removeItem('userToken');
        }
      }

      console.log('No valid tokens found, staying on homepage');
    }

    // Execute the redirection logic
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, checking authentication...');
      handleRedirection();

      // Initialize hamburger menu
      const hamburger = document.querySelector('.hamburger');
      const mobileMenu = document.querySelector('.mobile-menu');

      if (hamburger && mobileMenu) {
        hamburger.addEventListener('click', () => {
          mobileMenu.classList.toggle('show');
        });

        // Hide menu if user clicks outside
        document.addEventListener('click', (e) => {
          if (!hamburger.contains(e.target) && !mobileMenu.contains(e.target)) {
            mobileMenu.classList.remove('show');
          }
        });
      }
    });

    // Also check on page load in case DOMContentLoaded already fired
    if (document.readyState === 'complete') {
      console.log('Page already loaded, checking authentication...');
      handleRedirection();
    }

    // Login menu toggle
    document.getElementById('login-link').addEventListener('click', e => {
      e.preventDefault();
      const menu = document.getElementById('login-menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    // Mobile login menu toggle
    document.getElementById('mobile-login-link').addEventListener('click', e => {
      e.preventDefault();
      const menu = document.getElementById('mobile-login-menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    // Close menus when clicking outside
    document.addEventListener('click', e => {
      const menu = document.getElementById('login-menu');
      const mobileLoginMenu = document.getElementById('mobile-login-menu');
      
      if (!menu.contains(e.target) && e.target.id !== 'login-link') {
        menu.style.display = 'none';
      }
      
      if (!mobileLoginMenu.contains(e.target) && e.target.id !== 'mobile-login-link') {
        mobileLoginMenu.style.display = 'none';
      }
    });

    // Start questionnaire
    startBtn.addEventListener('click', () => showQuestion(0));

    // PWA installation handling
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) {
        alert('App is already installed or not available for installation');
        return;
      }
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        console.log('User accepted the install prompt');
      } else {
        console.log('User dismissed the install prompt');
      }
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });

    window.addEventListener('appinstalled', (evt) => {
      console.log('App was installed');
      installBtn.style.display = 'none';
    });

    // Add event listener for beforeunload to ensure tokens are preserved
    window.addEventListener('beforeunload', () => {
      localStorage.setItem('lastVisit', Date.now().toString());
    });
  </script>
</head>
<body>

  <header>
    <div class="glass">
      <div class="logo">
        <a href="/" class="logo-link">
          <img src="images/glowinglogonowback.webp" alt="Nevengi" class="logo-img" />
          <span class="logo-text">Nevengi™</span>
        </a>
      </div>
      <nav class="main-nav">
        <a href="https://nevengi-research-center.super.site/" target="_blank" rel="noopener noreferrer" class="nav-link">
          <button>NRC</button>
        </a>
        
        <!-- inline buttons (for wide screens) -->
        <div class="auth-buttons">
          <a href="#" id="login-link">Login</a>
          <div id="login-menu">
            <button onclick="location.href='/auth/discord/user'">
                <img src="images/colombian.gif" alt="User Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                User Login
            </button>
              
            <button onclick="location.href='/auth/discord'">
                <img src="images/mentorship.gif" alt="Coach Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                Coach Login
            </button>
          </div>
        </div>

        <!-- hamburger toggle -->
        <button class="hamburger" aria-label="Toggle menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>

        <!-- mobile menu -->
        <div class="mobile-menu">
          <a href="https://nevengi-research-center.super.site/" target="_blank" rel="noopener noreferrer" class="mobile-nav-link">
            <button>NRC</button>
          </a>
          <div class="mobile-login-wrapper">
            <a href="#" id="mobile-login-link">Login</a>
            <div id="mobile-login-menu">
              <button onclick="location.href='/auth/discord/user'">
                  <img src="images/colombian.gif" alt="User Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                  User Login
              </button>
                
              <button onclick="location.href='/auth/discord'">
                  <img src="images/mentorship.gif" alt="Coach Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                  Coach Login
              </button>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </header>

    <!-- Scrollable Feature Cards -->
  <section class="scroll-container">
    <div class="card-scroll">
      <img src="images/coach tranforamtion.png" alt="feature 1" />
      <p>Become a coach for your own followers</p>
    </div>

    <div class="card-scroll">
      <img src="images/18plus.webp" alt="feature 1" />
      <p>Are You 18 or Older ?</p>
    </div>
    <div class="card-scroll">
      <img src="images/followers.webp" alt="Feature 2" />
      <p>Do You have more than 5k followers in any of your social media accounts ?</p>
    </div>
    <div class="card-scroll">
      <img src="images/niche.webp" alt="Feature 3" />
      <p>Do you make content for a specific niche ?</p>
    </div>
    <div class="card-scroll">
      <img src="images/accountability.webp" alt="Feature 4" />
      <p>Being Accountable</p>
    </div>
    <div class="card-scroll">
      <img src="images/advice.webp" alt="Feature 5" />
      <p>Giving Advice</p>
    </div>
    <div class="card-scroll">
      <img src="images/socialmediacontent.webp" alt="Feature 6" />
      <p>Create content to get your followers to Nevengi</p>
    </div>
  </section>

  <section class="hero glass" id="hero">
    <!-- Hero Intro -->
    <div class="hero-text" id="hero-text">
      <h1>Unlock the<br> All-Rounder.</h1><br>
      <p>Tired of saving quotes and watching motivational videos?<br>
        It's time to stop dreaming and get practical.<br>
        <br>
        <p><b> Already have a follow base ?</b> Join Nevengi as an<b> Content Creator</b> & Earn While you help people</p>
        Unlock the All-Rounder.</p>
      <button class="btn-primary" id="start-btn">Get Started</button>
      <button class="btn-primary" id="install-btn" style="margin-top: 10px;">Install App</button>
    </div>
    <div class="hero-img" id="hero-img">
      <img src="images/mascot.webp" alt="Nevengi Character" />
    </div>

    <!-- Embedded Questionnaire -->
    <div id="questionnaire" class="glass"></div>
  </section>

  <!-- =========  FAQ  ===================================================== -->
<section id="faq" class="faq glass">
  <h2 class="faq-heading">Frequently Asked Questions</h2>

  <!-- ── Coaches ──────────────────────────────────────────────────────── -->
  <div class="faq-category">
    <h3 class="faq-subheading">For Coaches</h3>

    <details>
      <summary>How do I earn money with Nevengi?</summary>
      <p>You set your own monthly subscription price for followers.  
         Each time a user subscribes, funds are split automatically—80 % goes to you, the rest covers platform and payment-processing fees.</p>
    </details>

    <details>
      <summary>How long does it take to start earning?</summary>
      <p>As soon as your coaching profile is approved (typically within 24-48 hours) and you list a paid program, subscribers can start joining—so earnings can begin right away.</p>
    </details>

    <details>
      <summary>When will I get paid?</summary>
      <p>Payouts are processed every Friday. You'll receive funds in your connected account 5-7 business days after each payout run.</p>
    </details>
  </div>

  <!-- ── Users ─────────────────────────────────────────────────────────── -->
  <div class="faq-category">
    <h3 class="faq-subheading">For Users</h3>

    <details>
      <summary>How many coaches can I subscribe to at once?</summary>
      <p>You can keep up to <strong>five</strong> active coach subscriptions simultaneously. You're free to cancel or swap any of them each month.</p>
    </details>

    <details>
      <summary>What does my subscription include?</summary>
      <p>Access to your coach's daily challenges, direct messaging, progress tracking and exclusive Discord channels. Some coaches add bonus perks like live Q&amp;A calls or downloadable resources.</p>
    </details>
  </div>
</section>


  <!-- footer start -->
  <footer class="footer glass">
    <div class="footer-container">
      <!-- 1. Brand & copyright -->
      <div class="footer-col footer-brand">
        <p>© 2025 Nevengi. All Rights Reserved.</p>
      </div>
    </div>
  </footer>
</body>
</html>
